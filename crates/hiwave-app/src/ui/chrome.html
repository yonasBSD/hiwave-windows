<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiWave</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Background layers - warmer tones for less eye strain */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-elevated: #475569;

            /* Teal/Cyan Accent (HiWave signature) */
            --accent: #06b6d4;
            --accent-hover: #22d3ee;
            --accent-dark: #0891b2;
            --accent-subtle: rgba(6, 182, 212, 0.08);
            --accent-medium: rgba(6, 182, 212, 0.15);

            /* Text hierarchy */
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --text-disabled: #64748b;

            /* Borders - darker, more subtle */
            --border: #1f2937;
            --border-subtle: #16213e;
            --border-focus: #475569;

            /* Semantic colors */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;

            /* Layout */
            --sidebar-width: 220px;
            --sidebar-min-width: 48px;      /* Icon-only mode */
            --sidebar-max-width: 400px;
            --sidebar-compact-threshold: 120px;  /* Below this = icon mode */

            /* Animation tokens */
            --duration-instant: 0.08s;
            --duration-fast: 0.12s;
            --duration-normal: 0.2s;
            --duration-slow: 0.3s;
            --ease-standard: cubic-bezier(0.4, 0.0, 0.2, 1);
            --ease-decelerate: cubic-bezier(0.0, 0.0, 0.2, 1);
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* ========================================
           PHASE 3: DELIGHT - Micro-interactions
           ======================================== */

        /* Subtle pulse for loading/skeleton states */
        @keyframes subtlePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Skeleton loading shimmer */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton {
            background: linear-gradient(
                90deg,
                var(--bg-tertiary) 25%,
                var(--bg-elevated) 50%,
                var(--bg-tertiary) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        /* Sidebar section entrance animation */
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-8px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sidebar:not(.collapsed) .sidebar-section {
            animation: slideInLeft var(--duration-normal) var(--ease-decelerate);
        }

        .sidebar:not(.collapsed) .workspace-item,
        .sidebar:not(.collapsed) .shelf-item {
            animation: fadeInUp var(--duration-normal) var(--ease-decelerate);
            animation-fill-mode: both;
        }

        /* Stagger workspace items */
        .sidebar:not(.collapsed) .workspace-item:nth-child(1) { animation-delay: 0.02s; }
        .sidebar:not(.collapsed) .workspace-item:nth-child(2) { animation-delay: 0.04s; }
        .sidebar:not(.collapsed) .workspace-item:nth-child(3) { animation-delay: 0.06s; }
        .sidebar:not(.collapsed) .workspace-item:nth-child(4) { animation-delay: 0.08s; }
        .sidebar:not(.collapsed) .workspace-item:nth-child(5) { animation-delay: 0.10s; }

        /* Stagger shelf items */
        .sidebar:not(.collapsed) .shelf-item:nth-child(1) { animation-delay: 0.02s; }
        .sidebar:not(.collapsed) .shelf-item:nth-child(2) { animation-delay: 0.04s; }
        .sidebar:not(.collapsed) .shelf-item:nth-child(3) { animation-delay: 0.06s; }
        .sidebar:not(.collapsed) .shelf-item:nth-child(4) { animation-delay: 0.08s; }
        .sidebar:not(.collapsed) .shelf-item:nth-child(5) { animation-delay: 0.10s; }

        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            user-select: none;
            display: flex;
        }

        .context-menu {
            position: absolute;
            z-index: 9999;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            padding: 6px;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 160px;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity var(--duration-fast) var(--ease-standard),
                        visibility var(--duration-fast) var(--ease-standard),
                        transform var(--duration-fast) var(--ease-decelerate);
            transform: scale(0.95) translateY(-4px);
            transform-origin: top left;
        }

        .context-menu.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: scale(1) translateY(0);
        }

        .context-menu-item {
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            text-align: left;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            pointer-events: auto;
            position: relative;
            transition: all var(--duration-fast) var(--ease-standard);
            width: 100%;
        }

        .context-menu-item .icon {
            font-size: 14px;
            width: 18px;
            text-align: center;
            pointer-events: none;
            flex-shrink: 0;
        }

        .context-menu-item span:not(.icon) {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            flex: 1;
            pointer-events: none;
        }

        .context-menu-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .context-menu-item:hover span:not(.icon) {
            color: var(--text-primary);
        }

        .context-menu-item:active {
            transform: scale(0.98);
        }

        .context-menu-item.disabled {
            color: var(--text-disabled);
            cursor: default;
            opacity: 0.5;
        }

        .context-menu-item.disabled:hover {
            background: transparent;
        }

        .context-menu-item.destructive {
            color: var(--error);
        }

        .context-menu-item.destructive span:not(.icon) {
            color: var(--error);
        }

        .context-menu-item.destructive:hover {
            background: rgba(239, 68, 68, 0.15);
        }

        .context-menu-divider {
            display: block;
            height: 1px;
            background: var(--border-subtle);
            margin: 4px 0;
        }

        .hidden {
            display: none !important;
        }

        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.3);  /* Neutral gray */
            border-radius: 999px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(6, 182, 212, 0.4);  /* Purple only on hover */
        }

        /* Focus-visible outlines for accessibility */
        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .btn-primary:focus-visible,
        .mode-selector:focus-visible,
        .workspace-item.active:focus-visible {
            outline-color: white;
        }
        /* Persistent Sidebar - always visible, collapsible, resizable */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-min-width);
            max-width: var(--sidebar-max-width);
            height: 100%;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .sidebar:not(.resizing) {
            transition: width 0.2s ease;
        }

        .sidebar.resizing {
            user-select: none;
        }

        .sidebar.collapsed {
            width: 0 !important;
            min-width: 0 !important;
            border-right: none;
        }

        /* Sidebar resize handle */
        .sidebar-resize-handle {
            position: absolute;
            top: 0;
            right: -3px;
            width: 6px;
            height: 100%;
            cursor: ew-resize;
            background: transparent;
            z-index: 100;
            transition: background 0.15s ease;
        }

        .sidebar-resize-handle:hover,
        .sidebar-resize-handle.dragging {
            background: var(--accent);
        }

        /* Hide resize handle when sidebar is collapsed */
        .sidebar.collapsed .sidebar-resize-handle {
            display: none;
        }

        /* ============================================
           COMPACT MODE - Icon-only sidebar
           ============================================ */
        .sidebar.compact {
            width: var(--sidebar-min-width) !important;
        }

        /* Hide text elements in compact mode */
        .sidebar.compact .section-title,
        .sidebar.compact .workspace-name,
        .sidebar.compact .workspace-tab-count,
        .sidebar.compact .workspace-tab-list,
        .sidebar.compact .workspace-expander,
        .sidebar.compact .workspace-actions,
        .sidebar.compact .workspace-suspended,
        .sidebar.compact .shelf-item-title,
        .sidebar.compact .mode-selector,
        .sidebar.compact .mode-description,
        .sidebar.compact .new-workspace-form,
        .sidebar.compact .sidebar-btn,
        .sidebar.compact .shelf-section .section-content,
        .sidebar.compact .action-label,
        .sidebar.compact .section-collapse-btn {
            display: none !important;
        }

        /* Show section headers with just count */
        .sidebar.compact .section-header {
            justify-content: center;
            padding: 8px 4px;
            margin: 0;
        }

        .sidebar.compact .section-count {
            margin: 0;
            font-size: 11px;
        }

        /* Compact sections */
        .sidebar.compact .sidebar-section {
            padding: 4px;
        }

        /* Compact workspace icons */
        .sidebar.compact .workspace-section .section-content {
            display: block !important;
        }

        .sidebar.compact .workspace-list {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            max-height: none;
            overflow: visible;
        }

        .sidebar.compact .workspace-entry {
            display: contents;
        }

        .sidebar.compact .workspace-item {
            justify-content: center;
            padding: 6px;
            width: 36px;
            height: 36px;
            min-height: 36px;
            border-radius: 8px;
        }

        .sidebar.compact .workspace-icon {
            width: 22px;
            height: 22px;
            font-size: 11px;
            flex-shrink: 0;
        }

        /* Compact action items */
        .sidebar.compact .actions-section {
            padding: 8px 4px;
        }

        .sidebar.compact .action-item {
            justify-content: center;
            padding: 8px;
            gap: 0;
        }

        .sidebar.compact .action-icon {
            font-size: 16px;
        }

        .sidebar.compact .action-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            min-width: 14px;
            height: 14px;
            font-size: 9px;
            padding: 0 3px;
        }

        /* Tooltips on hover in compact mode */
        .sidebar.compact .workspace-item,
        .sidebar.compact .action-item {
            position: relative;
        }

        .sidebar.compact .workspace-item::after {
            content: attr(data-name);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
            z-index: 1000;
            margin-left: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .sidebar.compact .workspace-item:hover::after {
            opacity: 1;
        }

        /* Right Sidebar - mirrors left sidebar, on right side */
        .right-sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            align-self: stretch; /* Fill full height in flex container */
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: width 0.2s ease, min-width 0.2s ease;
            overflow: hidden;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .right-sidebar.collapsed {
            width: 0;
            min-width: 0;
            border-left: none;
        }

        .right-sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .right-sidebar-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .right-sidebar-close {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
        }

        .right-sidebar-close:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .right-sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 12px;
            gap: 8px;
            overflow-y: auto;
        }

        .right-sidebar-actions {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
        }

        .right-sidebar-action {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background: var(--accent-subtle);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .right-sidebar-action:hover {
            background: var(--accent-medium);
        }

        .right-sidebar-action .icon {
            font-size: 14px;
        }

        .right-sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .right-sidebar-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 8px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s ease;
        }

        .right-sidebar-tab:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .right-sidebar-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .right-sidebar-tab .icon {
            font-size: 14px;
        }

        .right-sidebar-panel {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .right-sidebar-panel.active {
            display: flex;
        }

        .right-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
        }

        .right-panel-header button {
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .right-panel-header button:hover {
            background: var(--bg-tertiary);
            color: var(--accent);
        }

        .right-panel-search {
            margin: 0 12px 8px;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 12px;
        }

        .right-panel-search:focus {
            outline: none;
            border-color: var(--accent);
        }

        .right-panel-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 12px 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .right-panel-empty {
            color: var(--text-muted);
            font-size: 12px;
            text-align: center;
            padding: 24px 12px;
        }

        .right-panel-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .right-panel-item:hover {
            background: var(--bg-elevated);
        }

        .right-panel-item-title {
            font-size: 12px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .right-panel-item-url {
            font-size: 10px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .right-panel-item-meta {
            font-size: 10px;
            color: var(--text-disabled);
        }

        .shortcuts-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px 12px;
            overflow-y: auto;
            flex: 1;
        }

        .shortcut-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 12px;
        }

        .shortcut-item kbd {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px 5px;
            font-family: ui-monospace, monospace;
            font-size: 11px;
            color: var(--text-muted);
        }

        .shortcut-item span:last-child {
            color: var(--text-primary);
            flex: 1;
            margin-left: 12px;
            text-align: right;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .sidebar-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-close {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
        }

        .sidebar-close:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .sidebar-content,
        .workspace-list,
        .workspace-tab-list,
        .shelf-list,
        .blocklist-dropdown,
        .downloads-list {
            scrollbar-width: thin;
            scrollbar-color: rgba(100, 116, 139, 0.3) transparent;
        }

        .sidebar-content::-webkit-scrollbar,
        .workspace-list::-webkit-scrollbar,
        .workspace-tab-list::-webkit-scrollbar,
        .shelf-list::-webkit-scrollbar,
        .blocklist-dropdown::-webkit-scrollbar,
        .downloads-list::-webkit-scrollbar {
            width: 5px;
        }

        .sidebar-content::-webkit-scrollbar-track,
        .workspace-list::-webkit-scrollbar-track,
        .workspace-tab-list::-webkit-scrollbar-track,
        .shelf-list::-webkit-scrollbar-track,
        .blocklist-dropdown::-webkit-scrollbar-track,
        .downloads-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-content::-webkit-scrollbar-thumb,
        .workspace-list::-webkit-scrollbar-thumb,
        .workspace-tab-list::-webkit-scrollbar-thumb,
        .shelf-list::-webkit-scrollbar-thumb,
        .blocklist-dropdown::-webkit-scrollbar-thumb,
        .downloads-list::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.3);
            border-radius: 999px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover,
        .workspace-list::-webkit-scrollbar-thumb:hover,
        .workspace-tab-list::-webkit-scrollbar-thumb:hover,
        .shelf-list::-webkit-scrollbar-thumb:hover,
        .blocklist-dropdown::-webkit-scrollbar-thumb:hover,
        .downloads-list::-webkit-scrollbar-thumb:hover {
            background: rgba(6, 182, 212, 0.4);
        }

        /* Workspace items in sidebar */
        .workspace-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all var(--duration-fast) var(--ease-standard);
            margin-bottom: 2px;
        }

        .workspace-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(2px);
        }

        .workspace-item:active {
            transform: translateX(2px) scale(0.98);
        }

        .workspace-item.active {
            background: var(--accent);
            box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
        }

        .workspace-item.workspace-drop-target {
            border: 1px dashed rgba(168, 85, 247, 0.7);
        }

        .workspace-item-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .workspace-item-count {
            font-size: 10px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .workspace-item.active .workspace-item-count {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .sidebar-divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0;
        }

        .sidebar-action {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--accent);
            transition: background 0.1s ease;
        }

        .sidebar-action:hover {
            background: var(--bg-tertiary);
        }

        /* Sidebar sections */
        .sidebar-section {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-section:first-child {
            padding-top: 20px;
        }

        .sidebar-section:last-child {
            border-bottom: none;
            margin-top: auto;
        }

        .workspace-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 48vh;
            min-height: 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            margin: 0 -8px 4px -8px;
            cursor: pointer;
            user-select: none;
            border-radius: 6px;
            transition: background 0.15s ease;
        }

        .section-header:hover {
            background: var(--bg-tertiary);
        }

        .section-header:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: -2px;
            background: var(--bg-tertiary);
        }

        .section-header[data-collapsible] {
            cursor: pointer;
        }

        .section-collapse-btn {
            background: none;
            border: none;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .collapse-icon {
            font-size: 10px;
            line-height: 1;
            transition: transform 0.2s ease;
        }

        .section-header[aria-expanded="false"] .collapse-icon {
            transform: rotate(-90deg);
        }

        .section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            color: var(--text-muted);
            flex: 1;
        }

        .section-count {
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        /* Collapsible section content */
        .section-content {
            overflow: hidden;
            transition: max-height 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.2s ease,
                        padding 0.15s ease;
        }

        .section-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }

        /* Workspace list in sidebar */
        .workspace-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 45vh;
            overflow-y: auto;
            overscroll-behavior: contain;
            padding-right: 4px;
            flex: 1;
            min-height: 0;
        }

        .workspace-entry {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .workspace-tab-list {
            display: none;
            flex-direction: column;
            gap: 4px;
            padding-left: 30px;
            max-height: 140px;
            overflow-y: auto;
        }

        .workspace-tab-list.open {
            display: flex;
        }

        .workspace-tab {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            padding: 6px 8px;
            border-radius: 4px;
            background: var(--bg-tertiary);
            font-size: 11px;
        }

        .workspace-tab.active {
            border: 1px solid var(--accent);
        }

        .workspace-tab:hover {
            background: var(--bg-primary);
        }

        .workspace-tab-title {
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            color: var(--text-muted);
        }

        .workspace-tab-lock-btn {
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .workspace-tab-lock-btn.locked {
            color: var(--accent);
        }

        .workspace-tab-lock-btn:hover {
            background: rgba(124,58,237,0.15);
            color: white;
        }

        .workspace-tab-empty {
            padding: 4px 8px;
            color: var(--text-muted);
            font-size: 11px;
        }

        /* Workspace tab decay visualization */
        .workspace-tab-decay-indicator {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .workspace-tab[data-decay="0"] .workspace-tab-decay-indicator { display: none; }
        .workspace-tab[data-decay="1"] .workspace-tab-decay-indicator { background: var(--success); }
        .workspace-tab[data-decay="2"] .workspace-tab-decay-indicator { background: #a3be8c; }
        .workspace-tab[data-decay="3"] .workspace-tab-decay-indicator { background: var(--warning); }
        .workspace-tab[data-decay="4"] .workspace-tab-decay-indicator { background: #d08770; }
        .workspace-tab[data-decay="5"] .workspace-tab-decay-indicator { background: var(--error); }

        .workspace-tab[data-decay="1"] { opacity: 0.9; }
        .workspace-tab[data-decay="2"] { opacity: 0.75; }
        .workspace-tab[data-decay="3"] { opacity: 0.6; }
        .workspace-tab[data-decay="4"] { opacity: 0.45; }
        .workspace-tab[data-decay="5"] { opacity: 0.35; }
        .workspace-tab[data-decay="5"] .workspace-tab-title { text-decoration: line-through; }

        .workspace-tab.active[data-decay],
        .workspace-tab:hover[data-decay] { opacity: 1; }
        .workspace-tab.locked[data-decay] { opacity: 1; }
        .workspace-tab.locked .workspace-tab-decay-indicator { display: none; }

        .workspace-expander {
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
            margin-left: auto;
            padding: 4px;
        }

        .workspace-expander:focus-visible {
            outline: 2px solid var(--accent);
        }

        .workspace-item .workspace-icon {
            font-size: 14px;
            margin-right: 8px;
        }

        .workspace-item .workspace-name {
            flex: 1;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .workspace-tab-count {
            font-size: 10px;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 2px 6px;
            min-width: 18px;
            text-align: center;
        }

        .workspace-lock-count {
            font-size: 10px;
            color: var(--success);
            background: rgba(16, 185, 129, 0.15);
            border-radius: 4px;
            padding: 2px 4px;
            margin-left: 6px;
        }

        .workspace-item .workspace-suspended {
            font-size: 10px;
            opacity: 0.6;
        }

        .workspace-item .workspace-actions {
            display: none;
            gap: 4px;
            margin-left: 8px;
        }

        .workspace-item:hover .workspace-actions {
            display: flex;
        }

        .workspace-item .workspace-actions button {
            width: 18px;
            height: 18px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .workspace-item .workspace-actions button:hover {
            background: var(--accent);
            color: white;
        }

        .workspace-item .workspace-actions button.confirm-delete {
            background: #e74c3c;
            color: white;
            animation: pulse-delete 0.5s ease-in-out infinite alternate;
        }

        @keyframes pulse-delete {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }

        .workspace-item .workspace-rename-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--accent);
            color: var(--text-primary);
            padding: 2px 6px;
            font-size: 13px;
            border-radius: 4px;
            outline: none;
        }

        /* Blocklist dropdown */
        .blocklist-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
        }

        .blocklist-dropdown.hidden {
            display: none;
        }

        .blocklist-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .blocklist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            margin-bottom: 4px;
        }

        .blocklist-item:hover {
            background: var(--bg-primary);
        }

        .blocklist-domain {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .blocklist-unblock {
            background: transparent;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 14px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .blocklist-unblock:hover {
            background: var(--error);
            color: white;
        }

        .blocklist-empty {
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
            padding: 12px;
        }

        /* Sidebar button */
        .sidebar-btn {
            width: 100%;
            padding: 6px 8px;
            margin-top: 8px;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .sidebar-btn:hover {
            background: var(--bg-tertiary);
            border-style: solid;
            color: var(--text-primary);
        }

        .sidebar-btn:active {
            transform: scale(0.97);
        }

        /* New workspace form */
        .new-workspace-form {
            margin-top: 8px;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .new-workspace-form.hidden {
            display: none;
        }

        .new-workspace-form input {
            width: 100%;
            padding: 6px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
            margin-bottom: 8px;
        }

        .new-workspace-form input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .new-workspace-actions {
            display: flex;
            gap: 6px;
        }

        .form-btn {
            flex: 1;
            padding: 5px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .form-btn.cancel {
            background: var(--bg-secondary);
            color: var(--text-muted);
        }

        .form-btn.confirm {
            background: var(--accent);
            color: white;
        }

        .form-btn:hover {
            opacity: 0.9;
        }

        .form-btn:active {
            transform: scale(0.97);
        }

        /* Mode Selector */
        .mode-selector {
            width: 100%;
            padding: 8px 12px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            transition: all var(--duration-normal) var(--ease-standard);
        }

        .mode-selector:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .mode-selector:active {
            transform: translateY(-1px) scale(0.98);
        }

        .mode-selector.essentials { background: #3b82f6; }
        .mode-selector.balanced { background: #f59e0b; }
        .mode-selector.zen { background: var(--accent); }

        .mode-description {
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Shelf */
        .shelf-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .shelf-count {
            font-size: 11px;
            padding: 2px 6px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-muted);
        }

        .shelf-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .shelf-item {
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .shelf-item:hover {
            background: var(--bg-primary);
            border-color: var(--border-focus);
            transform: translateX(2px);
        }

        .shelf-item:active {
            transform: translateX(2px) scale(0.98);
        }

        .shelf-item.decaying {
            opacity: 0.6;
        }

        .shelf-item.expiring {
            border-left: 2px solid var(--warning);
        }

        .shelf-item-header {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .shelf-favicon {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            background: var(--text-muted);
            flex-shrink: 0;
        }

        .shelf-item-info {
            flex: 1;
            min-width: 0;
        }

        .shelf-item-title {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .shelf-item-url {
            font-size: 10px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .shelf-pin {
            font-size: 10px;
        }

        .shelf-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
        }

        .shelf-age {
            font-size: 10px;
            color: var(--text-muted);
        }

        .shelf-age.warning {
            color: var(--warning);
        }

        /* Decay indicator - single color-coded dot */
        .decay-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            transition: all var(--duration-slow) var(--ease-standard);
        }

        .decay-indicator[data-level="0"] { background: var(--accent); }
        .decay-indicator[data-level="1"] { background: var(--success); }
        .decay-indicator[data-level="2"] { background: #a3be8c; }
        .decay-indicator[data-level="3"] { background: var(--warning); }
        .decay-indicator[data-level="4"] { background: #d08770; box-shadow: 0 0 4px #d08770; }
        .decay-indicator[data-level="5"] { background: var(--error); box-shadow: 0 0 4px var(--error); }

        /* Decay tooltip on hover */
        .shelf-item {
            position: relative;
        }

        .decay-tooltip {
            position: absolute;
            bottom: 100%;
            right: 0;
            padding: 5px 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
            margin-bottom: 6px;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(4px);
            transition: all var(--duration-fast) var(--ease-standard);
            z-index: 100;
        }

        .shelf-item:hover .decay-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .decay-tooltip.warning {
            color: var(--warning);
            border-color: var(--warning);
        }

        .decay-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 12px;
            border: 5px solid transparent;
            border-top-color: var(--border);
        }

        .decay-tooltip.warning::after {
            border-top-color: var(--warning);
        }

        .shelf-drop-hint {
            padding: 12px;
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
            border-top: 1px dashed var(--border);
            margin-top: 8px;
        }

        .shelf-drop-hint.drag-over {
            background: rgba(6, 182, 212, 0.1);
            color: var(--accent);
        }

        .shelf-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 12px;
            animation: fadeInUp var(--duration-slow) var(--ease-decelerate);
        }

        .shelf-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.4;
            filter: grayscale(0.3);
        }

        .shelf-empty-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .shelf-empty-description {
            font-size: 12px;
            color: var(--text-muted);
            max-width: 180px;
            line-height: 1.5;
        }

        .shelf-empty-hint {
            font-size: 10px;
            color: var(--text-disabled);
            margin-top: 12px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .shelf-empty-hint kbd {
            font-family: ui-monospace, monospace;
            background: var(--bg-primary);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
        }

        /* Workspace empty state */
        .workspace-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 32px 16px;
            animation: fadeInUp var(--duration-slow) var(--ease-decelerate);
        }

        .workspace-empty-icon {
            font-size: 36px;
            margin-bottom: 12px;
            opacity: 0.4;
        }

        .workspace-empty-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .workspace-empty-description {
            font-size: 11px;
            color: var(--text-muted);
            max-width: 160px;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .workspace-empty-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .workspace-empty-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .workspace-empty-btn:active {
            transform: scale(0.97);
        }

        /* Quick actions */
        .actions-section {
            padding: 8px;
        }

        .action-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .action-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .action-item:active {
            transform: scale(0.97);
        }

        .action-item.shield-status {
            background: rgba(6, 182, 212, 0.15);
            color: #a78bfa;
        }

        .action-icon {
            font-size: 14px;
        }

        .action-label {
            flex: 1;
            font-size: 13px;
        }

        .action-badge {
            font-size: 10px;
            padding: 2px 6px;
            background: rgba(6, 182, 212, 0.3);
            border-radius: 4px;
        }

        /* Nav items in sidebar */
        .nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all var(--duration-fast) var(--ease-standard);
            margin-bottom: 2px;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(2px);
        }

        .nav-item:active {
            transform: translateX(2px) scale(0.98);
        }

        .nav-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .nav-item.disabled:hover {
            background: transparent;
            transform: none;
        }

        .nav-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item-icon {
            width: 20px;
            text-align: center;
            font-size: 14px;
        }

        .nav-item-shortcut {
            font-size: 10px;
            font-family: ui-monospace, 'SF Mono', Monaco, 'Cascadia Code', monospace;
            color: var(--text-disabled);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }

        .nav-item:hover .nav-item-shortcut {
            color: var(--text-muted);
            background: var(--bg-elevated);
        }

        /* Main chrome area */
        .chrome-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            align-items: center;
            height: 44px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            padding: 6px 12px;
            gap: 4px;
        }

        /* Sidebar toggle buttons */
        .sidebar-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--accent);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.15s ease;
            margin-right: 8px;
        }

        .sidebar-toggle:hover {
            background: var(--accent-hover);
        }

        .sidebar-toggle.nav-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 6px 8px;
        }

        .sidebar-toggle.nav-toggle:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        /* HiWave Logo Toggle Styles */
        .sidebar-toggle.logo-toggle {
            background: transparent;
            border: 1px solid transparent;
            padding: 6px 12px;
            gap: 8px;
        }

        .sidebar-toggle.logo-toggle:hover {
            background: var(--bg-tertiary);
            border-color: var(--border);
        }

        .hiwave-logo {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .logo-icon {
            color: var(--accent);
            transition: transform 0.2s ease;
        }

        .sidebar-toggle.logo-toggle:hover .logo-icon {
            transform: scale(1.1);
        }

        .logo-text {
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .workspace-badge {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            background: var(--accent);
            color: var(--bg-primary);
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            opacity: 0.8;
            transition: opacity 0.15s ease;
        }

        .sidebar-toggle.logo-toggle:hover .workspace-badge {
            opacity: 1;
        }

        /* Hide logo text on smaller screens */
        @media (max-width: 800px) {
            .logo-text {
                display: none;
            }
        }

        .tabs {
            display: flex;
            flex: 1;
            gap: 2px;
            overflow-x: auto;
            padding: 4px 0;
        }

        .tabs::-webkit-scrollbar {
            height: 3px;
        }

        .tabs::-webkit-scrollbar-track {
            background: transparent;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: transparent;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            min-width: 100px;
            max-width: 180px;
            flex-shrink: 0; /* Prevent tabs from shrinking - enables overflow scrolling */
            transition: all var(--duration-fast) var(--ease-standard);
            border: 1px solid transparent;
            border-bottom: none;
            -webkit-user-drag: element;
            position: relative;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .tab.active {
            background: var(--bg-primary);
            border-color: var(--border);
        }

        .tab.dragging {
            opacity: 0.6;
        }

        /* Subtle separator between inactive tabs */
        .tab:not(.active):not(:hover)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 25%;
            bottom: 25%;
            width: 1px;
            background: var(--border-subtle);
        }

        .tab:hover::after,
        .tab.active::after,
        .tab:hover + .tab::after {
            display: none;
        }

        .tab-title {
            flex: 1;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-muted);
        }

        .tab.active .tab-title {
            color: var(--text-primary);
            font-weight: 500;
        }

        .tab:hover .tab-title {
            color: var(--text-secondary);
        }

        /* Tab entrance animation */
        @keyframes tabSlideIn {
            from {
                opacity: 0;
                transform: translateY(-4px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .tab {
            animation: tabSlideIn var(--duration-normal) var(--ease-decelerate);
        }

        /* Tab loading indicator */
        .tab.loading::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            animation: tabLoading 1.2s ease-in-out infinite;
        }

        @keyframes tabLoading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Tab decay visualization - progressive fade based on age */
        .tab[data-decay="1"] {
            opacity: 0.85;
        }
        .tab[data-decay="1"] .tab-title {
            color: var(--text-muted);
        }

        .tab[data-decay="2"] {
            opacity: 0.7;
        }
        .tab[data-decay="2"] .tab-title {
            color: var(--text-disabled);
        }

        .tab[data-decay="3"] {
            opacity: 0.55;
        }
        .tab[data-decay="3"] .tab-title {
            color: var(--text-disabled);
        }

        .tab[data-decay="4"] {
            opacity: 0.4;
        }
        .tab[data-decay="4"] .tab-title {
            color: var(--text-disabled);
            font-style: italic;
        }

        .tab[data-decay="5"] {
            opacity: 0.3;
        }
        .tab[data-decay="5"] .tab-title {
            color: var(--text-disabled);
            font-style: italic;
            text-decoration: line-through;
        }

        /* Decay indicator dot */
        .tab-decay-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .tab[data-decay="0"] .tab-decay-indicator { display: none; }
        .tab[data-decay="1"] .tab-decay-indicator { background: var(--success); }
        .tab[data-decay="2"] .tab-decay-indicator { background: #a3be8c; }
        .tab[data-decay="3"] .tab-decay-indicator { background: var(--warning); }
        .tab[data-decay="4"] .tab-decay-indicator { background: #d08770; }
        .tab[data-decay="5"] .tab-decay-indicator { background: var(--error); }

        /* Active/hover tabs override decay opacity */
        .tab.active[data-decay] {
            opacity: 1;
        }
        .tab:hover[data-decay] {
            opacity: 0.9;
        }

        /* Locked tabs don't show decay */
        .tab.locked[data-decay] {
            opacity: 1;
        }
        .tab.locked[data-decay] .tab-decay-indicator {
            display: none;
        }

        .tab-block {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 10px;
            color: var(--text-muted);
            opacity: 0;
            transition: all 0.15s ease;
            margin-right: 2px;
        }

        .tab:hover .tab-block {
            opacity: 1;
        }

        .tab-block:hover {
            background: var(--warning, #f59e0b);
            color: white;
        }

        .tab-audio {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 11px;
            color: var(--accent);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
            margin-right: 4px;
        }

        .tab-audio:hover {
            background: var(--accent-medium);
        }

        .tab-audio.muted {
            color: var(--text-muted);
        }

        .tab-close {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 14px;
            color: var(--text-muted);
            opacity: 0;
            pointer-events: none;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .tab:hover .tab-close,
        .tab.active .tab-close {
            opacity: 1;
            pointer-events: auto;
        }

        .tab-close:hover {
            background: var(--error);
            color: white;
        }

        /* Tab decay visualization */
        .tab[data-decay="1"] {
            opacity: 0.9;
        }
        .tab[data-decay="1"]::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent) 80%, transparent 80%);
        }

        .tab[data-decay="2"] {
            opacity: 0.8;
        }
        .tab[data-decay="2"]::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--warning, #f59e0b) 60%, transparent 60%);
        }

        .tab[data-decay="3"] {
            opacity: 0.7;
        }
        .tab[data-decay="3"]::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--warning, #f59e0b) 40%, transparent 40%);
        }

        .tab[data-decay="4"] {
            opacity: 0.6;
        }
        .tab[data-decay="4"]::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--error, #ef4444) 20%, transparent 20%);
        }

        .tab[data-decay="5"] {
            opacity: 0.45;
            filter: grayscale(50%);
        }
        .tab[data-decay="5"]::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--error, #ef4444);
            animation: decayPulse 2s ease-in-out infinite;
        }

        @keyframes decayPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Locked tabs don't show decay */
        .tab.locked[data-decay] {
            opacity: 1;
            filter: none;
        }
        .tab.locked[data-decay]::after {
            display: none;
        }

        .new-tab-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .new-tab-btn:active {
            transform: scale(0.95);
        }

        .new-tab-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(6, 182, 212, 0.1);
        }

        /* Tab controls container (for frameless window) */
        .tab-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            -webkit-app-region: no-drag;
        }

        .window-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .window-btn {
            width: 32px;
            height: 32px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            background: rgba(6, 182, 212, 0.12);
            color: var(--accent);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .window-btn:hover {
            background: rgba(6, 182, 212, 0.25);
            border-color: rgba(6, 182, 212, 0.45);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .window-btn:active {
            transform: translateY(0) scale(0.97);
        }

        .window-btn-close:hover {
            background: rgba(239, 68, 68, 0.85);
            border-color: rgba(239, 68, 68, 0.85);
            color: white;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            height: 48px;
            background: var(--bg-primary);
            padding: 0 12px;
            gap: 8px;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .toolbar-actions {
            margin-left: auto;
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toolbar-action-menu {
            position: relative;
            display: flex;
            align-items: center;
        }

        .toolbar-menu-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .toolbar-menu-btn:hover {
            border-color: var(--border-focus);
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .toolbar-menu-btn:active {
            transform: scale(0.95);
        }

        .toolbar-action-panel {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 60;
            width: 160px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .toolbar-action-panel button {
            border: none;
            background: transparent;
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s ease;
        }

        .toolbar-action-panel button:hover {
            background: rgba(6, 182, 212, 0.15);
        }

        .toolbar-action-panel button .menu-icon {
            margin-right: 8px;
        }

        /* Help panel styles */
        .help-panel {
            width: 260px;
            padding: 12px;
        }

        .help-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 12px;
        }

        .shortcut-row kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: inherit;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .shortcut-row span {
            color: var(--text-muted);
        }

        /* Tab Actions Panel - horizontal bar below toolbar */
        .tab-actions-panel {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            gap: 12px;
        }

        .tab-actions-panel.visible {
            display: flex;
        }

        .tab-actions-info {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
            flex-shrink: 1;
        }

        .tab-actions-favicon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .tab-actions-title {
            font-size: 12px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .tab-actions-buttons {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .tab-action-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 11px;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .tab-action-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .tab-action-btn .icon {
            font-size: 12px;
        }

        .tab-action-btn.destructive:hover {
            background: var(--error-subtle);
            border-color: var(--error);
            color: var(--error);
        }

        .tab-actions-close {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .tab-actions-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .downloads-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .downloads-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
        }

        .downloads-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(6, 182, 212, 0.1);
        }

        .downloads-icon {
            font-size: 16px;
        }

        .history-icon {
            font-size: 16px;
        }

        .downloads-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .downloads-panel {
            position: absolute;
            top: calc(100% + 6px);
            right: 18px;
            width: 320px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 220;
        }

        .history-panel {
            position: absolute;
            top: calc(100% + 6px);
            right: 18px;
            width: 360px;
            max-height: 360px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 220;
        }

        .history-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            color: var(--text-primary);
        }

        .history-panel-header button {
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .history-panel-header button:hover {
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent);
        }

        .history-search {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 13px;
        }

        .history-panel,
        .history-list {
            scrollbar-width: thin;
            scrollbar-color: rgba(6, 182, 212, 0.4) transparent;
        }

        .history-panel::-webkit-scrollbar,
        .history-list::-webkit-scrollbar {
            width: 5px;
        }

        .history-panel::-webkit-scrollbar-track,
        .history-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .history-panel::-webkit-scrollbar-thumb,
        .history-list::-webkit-scrollbar-thumb {
            background: rgba(6, 182, 212, 0.25);
            border-radius: 999px;
        }

        .history-panel::-webkit-scrollbar-thumb:hover,
        .history-list::-webkit-scrollbar-thumb:hover {
            background: rgba(6, 182, 212, 0.6);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            max-height: 260px;
        }

        .history-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px;
            border-radius: 10px;
            background: var(--bg-primary);
            border: 1px solid transparent;
            cursor: pointer;
            transition: border 0.2s ease, background 0.2s ease;
        }

        .history-item:hover {
            border-color: var(--border);
            background: rgba(6, 182, 212, 0.1);
        }

        .history-item-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .history-item-url {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
        }

        .history-meta-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .history-item-count {
            font-weight: 600;
            color: var(--accent);
        }

        .history-item-workspace {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 8px;
        }

        .history-empty {
            text-align: center;
            font-size: 13px;
            color: var(--text-muted);
        }

        .downloads-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .downloads-panel-header button {
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 11px;
            text-transform: none;
        }

        .downloads-list {
            max-height: 260px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .download-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .download-item-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .download-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .download-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(6, 182, 212, 0.2);
            color: var(--text-muted);
            text-transform: capitalize;
            min-width: 70px;
            text-align: center;
        }

        .download-url-line {
            font-size: 11px;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .download-actions {
            display: flex;
            gap: 6px;
        }

        .download-action {
            flex: 1;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-primary);
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: border-color 0.2s ease, color 0.2s ease;
        }

        .download-action:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
        }

        .download-action:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .download-empty {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            padding: 20px 0;
        }

        /* Find Modal (compact command palette style) */
        .find-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9999;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 8px;
        }

        .find-modal-overlay.open {
            display: flex;
        }

        .find-modal-container {
            display: flex;
            align-items: center;
            gap: 12px;
            animation: findModalIn 0.15s ease-out;
        }

        @keyframes findModalIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .find-modal {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            padding: 8px 12px;
        }

        .find-modal-input {
            width: 180px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .find-modal-input::placeholder {
            color: var(--text-muted);
        }

        .find-modal-count {
            font-size: 11px;
            color: var(--text-muted);
            min-width: 36px;
            text-align: center;
            white-space: nowrap;
        }

        .find-modal-nav {
            display: flex;
            gap: 2px;
        }

        .find-modal-btn {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 10px;
            transition: all 0.15s ease;
        }

        .find-modal-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .find-modal-btn.active {
            background: rgba(6, 182, 212, 0.2);
            border-color: var(--accent);
            color: var(--accent);
        }

        .find-modal-close {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            margin-left: 4px;
            transition: color 0.15s ease, background 0.15s ease;
        }

        .find-modal-close:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .find-modal-hint-left,
        .find-modal-hint-right {
            font-size: 11px;
            color: var(--text-muted);
            opacity: 0.7;
            white-space: nowrap;
        }

        .find-modal-hint-left kbd,
        .find-modal-hint-right kbd {
            background: rgba(255, 255, 255, 0.08);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 10px;
        }

        /* Navigation buttons group */
        .nav-buttons {
            display: flex;
            gap: 4px;
        }

        .nav-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.15s ease;
        }

        /* Debug-only elements - hidden unless debug mode is enabled */
        .debug-only {
            display: none !important;
        }
        body.debug-mode .debug-only {
            display: flex !important;
        }

        .nav-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .nav-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .nav-btn.disabled:hover {
            transform: none;
        }

        /* Shield button */
        .shield-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid var(--accent);
            border-radius: 6px;
            color: #a78bfa;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .shield-btn:hover {
            background: rgba(6, 182, 212, 0.25);
        }

        .shield-btn #shieldCount {
            font-size: 11px;
            font-weight: 600;
        }

        /* Address Bar */
        .address-bar {
            flex: 1;
            display: flex;
            align-items: center;
            height: 36px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0 14px;
            gap: 8px;
            transition: all var(--duration-fast) var(--ease-standard);
            user-select: text;
            -webkit-user-select: text;
        }

        .address-bar:hover {
            border-color: var(--border-focus);
        }

        .address-bar:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-subtle);
            background: var(--bg-primary);
        }

        .address-bar input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            user-select: text !important;
            -webkit-user-select: text !important;
            cursor: text;
            -webkit-touch-callout: default;
            pointer-events: auto;
        }

        .address-bar input::placeholder {
            color: var(--text-disabled);
        }

        .address-bar input::selection {
            background: rgba(6, 182, 212, 0.5);
            color: var(--text-primary);
        }

        /* Zoom Indicator */
        .zoom-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 28px;
            min-width: 48px;
            padding: 0 8px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .zoom-indicator:hover {
            background: var(--accent-medium);
        }

        .zoom-indicator span {
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 4px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-focus);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        /* Loading indicator */
        .loading-indicator {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .loading-indicator.active {
            animation: loadingPulse 1.5s ease-in-out infinite;
        }

        @keyframes loadingPulse {
            0% { transform: scaleX(0); }
            50% { transform: scaleX(0.7); }
            100% { transform: scaleX(1); }
        }

        /* ========================================
           HIWAVE WHIMSY ENHANCEMENTS
           ======================================== */

        /* Enhanced tab hover with lift and glow */
        .tab:hover {
            background: rgba(255, 255, 255, 0.05) !important;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(6, 182, 212, 0.15);
        }

        .tab.active {
            box-shadow: 0 0 0 1px var(--accent-subtle),
                        0 2px 12px rgba(6, 182, 212, 0.2);
        }

        /* Sidebar button press feedback */
        .sidebar-btn:active,
        .btn-primary:active {
            transform: scale(0.95);
        }

        /* Workspace item press animation */
        .workspace-item:active {
            transform: translateX(2px) scale(0.98) !important;
        }

        /* Shelf item hover enhancement */
        .shelf-item:hover {
            transform: translateX(3px);
            box-shadow: -3px 0 0 var(--accent);
        }

        /* Nav button hover glow */
        .nav-btn:hover {
            box-shadow: 0 0 12px rgba(6, 182, 212, 0.3);
        }

        /* Address bar focus enhancement */
        .address-bar:focus {
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2),
                        0 2px 16px rgba(6, 182, 212, 0.15);
        }

        /* Loading indicator enhancement */
        @keyframes loadingGlow {
            0%, 100% { box-shadow: 0 0 5px var(--accent); }
            50% { box-shadow: 0 0 15px var(--accent-hover); }
        }

        .loading-indicator.active {
            animation: loadingPulse 1.5s ease-in-out infinite,
                       loadingGlow 2s ease-in-out infinite;
        }

        /* Context menu entrance bounce */
        @keyframes contextMenuBounce {
            0% { opacity: 0; transform: scale(0.8) translateY(-10px); }
            60% { transform: scale(1.05) translateY(0); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .context-menu.visible {
            animation: contextMenuBounce 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Tab close button satisfying feedback */
        .tab-close:hover {
            background: var(--error) !important;
            color: white !important;
            transform: rotate(90deg) scale(1.1);
        }

        .tab-close:active {
            transform: rotate(90deg) scale(0.9);
        }

        /* Shield badge pulse when active */
        @keyframes shieldPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .action-item:hover .action-badge {
            animation: shieldPulse 0.6s ease-in-out;
        }

        /* Mode selector smooth transitions */
        .mode-selector:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 12px rgba(6, 182, 212, 0.2);
        }

        /* New tab button delight */
        .new-tab-btn:hover {
            transform: rotate(90deg) scale(1.1);
        }

        .new-tab-btn:active {
            transform: rotate(90deg) scale(0.95);
        }

        /* Workspace count badge pulse */
        .workspace-item:hover .workspace-count {
            transform: scale(1.1);
        }

        /* ========================================
           REDUCED MOTION SUPPORT
           ======================================== */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .tab:hover,
            .workspace-item:hover,
            .shelf-item:hover,
            .tab-close:hover,
            .new-tab-btn:hover,
            .mode-selector:hover {
                transform: none !important;
            }
        }

        /* ========================================
           FOCUS MODE STYLES
           ======================================== */

        /* Focus mode progress bar at top of screen */
        .focus-progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--bg-tertiary);
            z-index: 10000;
            opacity: 0;
            transform: translateY(-100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .focus-progress-bar.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .focus-progress-bar .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-hover));
            width: 0%;
            transition: width 0.15s ease-out;
            box-shadow: 0 0 8px var(--accent);
        }

        /* Focus mode toggle button in chrome */
        .focus-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            margin-left: 8px;
        }

        .focus-toggle-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .focus-toggle-btn.active {
            background: var(--accent-medium);
            color: var(--accent);
        }

        .focus-toggle-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Focus mode indicator in tab bar */
        .focus-indicator {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--accent-subtle);
            border: 1px solid var(--accent-dark);
            border-radius: 4px;
            color: var(--accent);
            font-size: 11px;
            font-weight: 500;
            margin-left: auto;
        }

        .focus-indicator.visible {
            display: flex;
        }

        .focus-indicator .focus-dot {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: focusPulse 2s ease-in-out infinite;
        }

        @keyframes focusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        /* Focus mode fade animation for entering/exiting */
        @keyframes focusEnter {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes focusExit {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        body.focus-mode-entering {
            animation: focusEnter 0.3s ease forwards;
        }

        body.focus-mode-exiting {
            animation: focusExit 0.3s ease forwards;
        }

        /* When in focus mode, hide all UI elements but keep progress bar */
        body.focus-mode .sidebar,
        body.focus-mode .right-sidebar,
        body.focus-mode .tab-bar-container,
        body.focus-mode .url-bar-container,
        body.focus-mode .toolbar,
        body.focus-mode .find-modal-overlay,
        body.focus-mode #tabActionsPanel,
        body.focus-mode #shortcutsPanel {
            opacity: 0 !important;
            pointer-events: none !important;
            visibility: hidden !important;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        /* Focus mode keyboard shortcut hint */
        .focus-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 16px;
            color: var(--text-secondary);
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .focus-hint.visible {
            opacity: 1;
        }

        .focus-hint kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 2px 6px;
            font-family: inherit;
            font-size: 11px;
            margin: 0 2px;
        }

        /* Peek mode reveal zone (subtle trigger area at top center) */
        .focus-reveal-zone {
            position: fixed;
            top: 0;
            left: 20%;
            width: 60%;
            height: 20px;
            z-index: 10002;
            /* Subtle gradient - visible but not distracting */
            background: linear-gradient(
                to bottom,
                rgba(99, 102, 241, 0.4) 0%,
                rgba(99, 102, 241, 0.15) 50%,
                transparent 100%
            );
            pointer-events: auto;
            display: none;
            border-radius: 0 0 8px 8px;
            transition: opacity 0.2s ease;
        }

        .focus-reveal-zone:hover {
            background: linear-gradient(
                to bottom,
                rgba(99, 102, 241, 0.6) 0%,
                rgba(99, 102, 241, 0.3) 50%,
                transparent 100%
            );
        }

        body.focus-mode .focus-reveal-zone {
            display: block;
        }

        /* Peek mode - show minimal toolbar */
        body.peek-mode .toolbar,
        body.peek-mode .url-bar-container {
            opacity: 0.95 !important;
            pointer-events: auto !important;
            transform: translateY(0);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        body.peek-mode .toolbar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Hide sidebar and tab bar in peek mode */
        body.peek-mode .sidebar,
        body.peek-mode .tab-bar-container {
            opacity: 0 !important;
            pointer-events: none !important;
            visibility: hidden !important;
        }

        /* Peek mode exit button */
        .peek-exit-btn {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--accent-subtle);
            border: 1px solid var(--accent-dark);
            border-radius: 4px;
            color: var(--accent);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-left: auto;
        }

        .peek-exit-btn:hover {
            background: var(--accent-medium);
        }

        body.peek-mode .peek-exit-btn {
            display: flex;
        }

        /* Keep focus test button visible in peek mode */
        body.peek-mode #focusTestBtn {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Cursor hide after inactivity */
        body.cursor-hidden,
        body.cursor-hidden * {
            cursor: none !important;
        }
    </style>
</head>
<body>
    <!-- Focus Mode Progress Bar -->
    <div class="focus-progress-bar" id="focusProgressBar">
        <div class="progress-fill" id="focusProgressFill"></div>
    </div>

    <!-- Focus Mode Hint (shown briefly when entering) -->
    <div class="focus-hint" id="focusHint">
        Press <kbd id="focusHintKey">Ctrl+Shift+F</kbd> or <kbd>Esc</kbd> to exit focus mode
    </div>

    <!-- Focus Mode Reveal Zone (triggers peek mode on hover) -->
    <div class="focus-reveal-zone" id="focusRevealZone"></div>

    <!-- Unified Sidebar - collapsed by default -->
    <aside class="sidebar collapsed" id="sidebar">
        <!-- Mode section -->
        <section class="sidebar-section">
            <div class="section-header">
                <span class="section-title">Mode</span>
            </div>
            <select class="mode-selector" id="modeSelector">
                <option value="essentials">&#9889; Essentials</option>
                <option value="balanced">&#9878; Balanced</option>
                <option value="zen" selected>&#129496; Zen</option>
            </select>
            <div class="mode-description" id="modeDescription">
                Full automation with undo
            </div>
        </section>

        <!-- Quick actions -->
        <section class="sidebar-section actions-section">
            <div class="action-item shield-status" id="sidebarShieldStatus">
                <span class="action-icon">&#128737;</span>
                <span class="action-label">Shield</span>
                <span class="action-badge" id="sidebarShieldBadge">0</span>
            </div>
            <div class="action-item" id="sidebarBlocklistBtn" style="position: relative;">
                <span class="action-icon">&#128683;</span>
                <span class="action-label">Blocked Sites</span>
                <span class="action-badge" id="sidebarBlocklistBadge">0</span>
                <div class="blocklist-dropdown hidden" id="blocklistDropdown">
                    <div class="blocklist-title">User Blocked Sites</div>
                    <div id="blocklistContent"></div>
                </div>
            </div>
            <div class="action-item" id="sidebarReportBtn">
                <span class="action-icon">&#128200;</span>
                <span class="action-label">Analytics Report</span>
            </div>
            <div class="action-item" id="sidebarSettingsBtn">
                <span class="action-icon">&#9881;</span>
                <span class="action-label">Settings</span>
            </div>
        </section>

        <!-- Workspaces section (collapsible) -->
        <section class="sidebar-section workspace-section">
            <div class="section-header" data-collapsible="workspaces" aria-expanded="true">
                <button class="section-collapse-btn" aria-label="Toggle workspaces">
                    <span class="collapse-icon">&#x25BE;</span>
                </button>
                <span class="section-title">Workspaces</span>
                <span class="section-count" id="workspaceCount">0</span>
            </div>
            <div class="section-content" id="workspaceContent">
                <div class="workspace-list" id="sidebarWorkspaceList">
                    <!-- Rendered by JS -->
                </div>
                <button class="sidebar-btn" id="newWorkspaceBtn">
                    <span>+</span> New Workspace
                </button>
                <div class="new-workspace-form hidden" id="newWorkspaceForm">
                    <input type="text" id="newWorkspaceName" placeholder="Workspace name..." maxlength="50">
                    <div class="new-workspace-actions">
                        <button class="form-btn cancel" id="cancelNewWorkspace">Cancel</button>
                        <button class="form-btn confirm" id="confirmNewWorkspace">Create</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Shelf section (collapsible) -->
        <section class="sidebar-section shelf-section">
            <div class="section-header" data-collapsible="shelf" aria-expanded="true">
                <button class="section-collapse-btn" aria-label="Toggle shelf">
                    <span class="collapse-icon">&#x25BE;</span>
                </button>
                <span class="section-title" id="shelfTitle">The Shelf</span>
                <span class="section-count" id="shelfCount">0</span>
            </div>
            <div class="section-content" id="shelfContent">
                <div class="shelf-list" id="shelfList">
                    <!-- Rendered by JS -->
                </div>
                <div class="shelf-drop-hint" id="shelfDropHint">
                    Drag tabs here to shelve
                </div>
            </div>
        </section>

        <!-- Resize Handle -->
        <div class="sidebar-resize-handle" id="sidebarResizeHandle" aria-label="Resize sidebar"></div>
    </aside>

    <!-- Main Chrome Area -->
    <div class="chrome-main" id="chromeMain">
        <!-- Tab Bar -->
        <div class="tab-bar">
            <!-- HiWave Logo Toggle -->
            <button class="sidebar-toggle logo-toggle" id="sidebarLogoToggle" title="Toggle Sidebar (Ctrl+B)">
                <div class="hiwave-logo">
                    <svg class="logo-icon" viewBox="0 0 24 24" width="20" height="20">
                        <!-- HiWave logo - ocean wave design -->
                        <path d="M2 13C4 13 6 9 9 9C12 9 14 13 17 13C20 13 22 9 22 9"
                              stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
                        <path d="M2 17C4 17 6 13 9 13C12 13 14 17 17 17C20 17 22 13 22 13"
                              stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" opacity="0.5"/>
                    </svg>
                    <span class="logo-text">HiWave</span>
                </div>
                <span class="workspace-badge" id="workspaceBadge" title="Current workspace">W</span>
            </button>

            <div class="tabs" id="tabs">
                <!-- Tabs will be rendered dynamically -->
            </div>
            <div class="tab-controls">
                <button class="new-tab-btn" id="newTabBtn" title="New Tab (Ctrl+T)">+</button>
                <div class="window-controls">
                    <button class="window-btn window-btn-minimize" id="windowMinimizeBtn" title="Minimize">&minus;</button>
                    <button class="window-btn window-btn-maximize" id="windowMaximizeBtn" title="Maximize">&#9633;</button>
                    <button class="window-btn window-btn-close" id="windowCloseBtn" title="Close">&#10005;</button>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <!-- Sidebar Toggle Button (hamburger) -->
            <div class="nav-btn" id="sidebarToggle" title="Toggle Sidebar (Ctrl+B)">&#x2630;</div>

            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <div class="nav-btn" id="backBtn" title="Back">&#x2190;</div>
                <div class="nav-btn" id="forwardBtn" title="Forward">&#x2192;</div>
                <div class="nav-btn" id="refreshBtn" title="Refresh">&#x21BB;</div>
            </div>

            <!-- Address Bar -->
            <div class="address-bar">
                <input type="text" id="urlInput" placeholder="Search or enter URL..." autocomplete="off" spellcheck="false">
            </div>

            <!-- Zoom Indicator (hidden at 100%) -->
            <div class="zoom-indicator" id="zoomIndicator" style="display: none;" title="Click to reset zoom">
                <span id="zoomLevel">100%</span>
            </div>

            <!-- Focus Mode Test Button (only visible in debug mode) -->
            <div class="nav-btn debug-only" id="focusTestBtn" title="Toggle Focus Mode (Ctrl+Shift+F)" style="font-size: 14px;">&#x1F4A1;</div>

            <!-- Shield Button -->
            <div class="shield-btn" id="shieldBtn" title="Flow Shield">
                <span>&#x1F6E1;</span>
                <span id="shieldCount">0</span>
            </div>

            <!-- Peek Mode Exit Button (only visible in peek mode) -->
            <button class="peek-exit-btn" id="peekExitBtn" title="Exit Focus Mode">
                <span>&#x2715;</span> Exit Focus
            </button>

            <div class="toolbar-actions">
                <button class="toolbar-menu-btn" id="toolbarMenuBtn" title="Menu">&#9776;</button>
            </div>

            <div class="loading-indicator" id="loadingIndicator"></div>
        </div>

        <!-- Tab Actions Panel - horizontal bar for tab context actions -->
        <div class="tab-actions-panel" id="tabActionsPanel">
            <div class="tab-actions-info">
                <img class="tab-actions-favicon" id="tabActionsFavicon" src="" alt="">
                <span class="tab-actions-title" id="tabActionsTitle">Tab Title</span>
            </div>
            <div class="tab-actions-buttons">
                <button type="button" class="tab-action-btn" id="tabActionLock" title="Lock tab">
                    <span class="icon">&#128274;</span>
                    <span class="label">Lock</span>
                </button>
                <button type="button" class="tab-action-btn" id="tabActionShelve" title="Move to shelf">
                    <span class="icon">&#128229;</span>
                    <span class="label">Shelve</span>
                </button>
                <button type="button" class="tab-action-btn" id="tabActionMove" title="Move to workspace">
                    <span class="icon">&#128193;</span>
                    <span class="label">Move</span>
                </button>
                <button type="button" class="tab-action-btn" id="tabActionDuplicate" title="Duplicate tab">
                    <span class="icon">&#128203;</span>
                    <span class="label">Duplicate</span>
                </button>
                <button type="button" class="tab-action-btn" id="tabActionCopyUrl" title="Copy URL">
                    <span class="icon">&#128279;</span>
                    <span class="label">Copy URL</span>
                </button>
                <button type="button" class="tab-action-btn destructive" id="tabActionCloseOthers" title="Close other tabs">
                    <span class="icon">&#128465;</span>
                    <span class="label">Close Others</span>
                </button>
                <button type="button" class="tab-action-btn destructive" id="tabActionClose" title="Close tab">
                    <span class="icon">&#10005;</span>
                    <span class="label">Close</span>
                </button>
            </div>
            <button type="button" class="tab-actions-close" id="tabActionsPanelClose" title="Close panel">&times;</button>
        </div>

        <div class="downloads-panel hidden" id="downloadsPanel">
            <div class="downloads-panel-header">
                <span>Downloads</span>
                <button id="clearDownloadsBtn" title="Clear downloads">Clear</button>
            </div>
            <div class="downloads-list" id="downloadsList">
                <div class="download-empty">No downloads yet</div>
            </div>
        </div>
        <div class="history-panel hidden" id="historyPanel">
            <div class="history-panel-header">
                <span>History</span>
                <button id="clearHistoryBtn" title="Clear visit history">Clear</button>
            </div>
            <input type="search" class="history-search" id="historySearch" placeholder="Search history..." autocomplete="off" spellcheck="false">
            <div class="history-list" id="historyList">
                <div class="history-empty">No history recorded yet</div>
            </div>
        </div>

    </div>

    <!-- Right Sidebar - Downloads/History -->
    <aside class="right-sidebar collapsed" id="rightSidebar">
        <div class="right-sidebar-header">
            <span class="right-sidebar-title">Tools</span>
            <button type="button" class="right-sidebar-close" id="rightSidebarClose">&times;</button>
        </div>
        <div class="right-sidebar-actions">
            <button type="button" class="right-sidebar-action" id="rightSidebarSearch">
                <span class="icon">&#128269;</span>
                <span>Search</span>
            </button>
            <button type="button" class="right-sidebar-action" id="rightSidebarHelp">
                <span class="icon">?</span>
                <span>Shortcuts</span>
            </button>
        </div>
        <div class="right-sidebar-tabs">
            <button type="button" class="right-sidebar-tab active" id="rightSidebarDownloads" data-panel="downloads">
                <span class="icon">&#11015;</span>
                <span>Downloads</span>
            </button>
            <button type="button" class="right-sidebar-tab" id="rightSidebarHistory" data-panel="history">
                <span class="icon">&#128337;</span>
                <span>History</span>
            </button>
        </div>
        <div class="right-sidebar-content">
            <!-- Downloads Panel -->
            <div class="right-sidebar-panel active" id="rightDownloadsPanel">
                <div class="right-panel-header">
                    <span>Recent Downloads</span>
                    <button id="rightClearDownloadsBtn" title="Clear">Clear</button>
                </div>
                <div class="right-panel-list" id="rightDownloadsList">
                    <div class="right-panel-empty">No downloads yet</div>
                </div>
            </div>
            <!-- History Panel -->
            <div class="right-sidebar-panel" id="rightHistoryPanel">
                <div class="right-panel-header">
                    <span>Recent History</span>
                    <button id="rightClearHistoryBtn" title="Clear">Clear</button>
                </div>
                <input type="search" class="right-panel-search" id="rightHistorySearch" placeholder="Search history..." autocomplete="off" spellcheck="false">
                <div class="right-panel-list" id="rightHistoryList">
                    <div class="right-panel-empty">No history yet</div>
                </div>
            </div>
            <!-- Shortcuts Panel -->
            <div class="right-sidebar-panel" id="rightShortcutsPanel">
                <div class="right-panel-header">
                    <span>Keyboard Shortcuts</span>
                </div>
                <div class="shortcuts-list" id="shortcutsList">
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>K</kbd><span>Command Palette</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>T</kbd><span>New Tab</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>W</kbd><span>Close Tab</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>1-9</kbd><span>Switch to Tab (1-9)</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>S</kbd><span>Shelve Tab</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>L</kbd><span>Focus Address Bar</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>R</kbd> / <kbd>F5</kbd><span>Reload Page</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>B</kbd><span>Toggle Sidebar</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>F</kbd><span>Find on Page</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>H</kbd><span>Toggle History</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>P</kbd><span>Print Page</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>+</kbd><span>Zoom In</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>-</kbd><span>Zoom Out</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>0</kbd><span>Reset Zoom</span></div>
                    <div class="shortcut-item"><kbd data-key="mod">Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>L</kbd><span>Autofill Password</span></div>
                    <div class="shortcut-item" id="focusModeShortcut"><kbd data-key="mod">Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>F</kbd> / <kbd>F11</kbd><span>Focus Mode</span></div>
                    <div class="shortcut-item"><kbd data-key="alt">Alt</kbd>+<kbd></kbd><span>Go Back</span></div>
                    <div class="shortcut-item"><kbd data-key="alt">Alt</kbd>+<kbd></kbd><span>Go Forward</span></div>
                    <div class="shortcut-item"><kbd data-key="alt">Alt</kbd>+<kbd>Home</kbd><span>Go Home</span></div>
                    <div class="shortcut-item"><kbd>F3</kbd> / <kbd>Shift</kbd>+<kbd>F3</kbd><span>Find Next/Previous</span></div>
                    <div class="shortcut-item"><kbd>Esc</kbd><span>Close Panels / Exit Focus</span></div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Find Modal (compact command palette style) -->
    <div class="find-modal-overlay" id="findModal" aria-hidden="true">
        <div class="find-modal-container">
            <span class="find-modal-hint-left"><kbd>&#x21E7;Enter</kbd> prev</span>
            <div class="find-modal">
                <input type="search" class="find-modal-input" id="findInput" placeholder="Find on page..." autocomplete="off" spellcheck="false">
                <span class="find-modal-count" id="findCount">0/0</span>
                <div class="find-modal-nav">
                    <button type="button" class="find-modal-btn" id="findPrevBtn" title="Previous (Shift+Enter)">&#x25B2;</button>
                    <button type="button" class="find-modal-btn" id="findNextBtn" title="Next (Enter)">&#x25BC;</button>
                    <button type="button" class="find-modal-btn" id="findCaseBtn" title="Case sensitive">Aa</button>
                </div>
                <button type="button" class="find-modal-close" id="findCloseBtn" title="Close (Esc)">&times;</button>
            </div>
            <span class="find-modal-hint-right"><kbd>Enter</kbd> next</span>
        </div>
    </div>

    <div id="contextMenu" class="context-menu"></div>
    <script>
        // Current state
        let currentTabs = [];
        let currentWorkspaces = [];
        let activeTabId = null;
        let activeWorkspaceId = null;
        let expandedWorkspaceId = null;
        let workspacesInitialized = false; // Track first render for auto-expand

        // Check for debug mode (set by Rust via script injection)
        // Will be enabled if HIWAVE_DEBUG=1 environment variable is set
        window.hiwaveDebug = false;
        window.enableDebugMode = function() {
            window.hiwaveDebug = true;
            document.body.classList.add('debug-mode');
            console.log('[HiWave] Debug mode enabled');
        };

        // Global zoom indicator update function (called from Rust)
        window.updateZoomIndicator = function(level) {
            const indicator = document.getElementById('zoomIndicator');
            const levelSpan = document.getElementById('zoomLevel');
            if (!indicator || !levelSpan) return;

            const pct = Math.round(level * 100);
            if (pct === 100) {
                indicator.style.display = 'none';
            } else {
                indicator.style.display = 'flex';
                levelSpan.textContent = pct + '%';
            }
        };

        // HiWave global object for IPC callbacks
        window.hiwave = {
            // Update tab decay visualization
            updateDecay: function(data) {
                if (!data || !data.tabs) return;
                data.tabs.forEach(function(tab) {
                    const tabEl = document.querySelector(`.tab[data-tab-id="${tab.id}"]`);
                    if (tabEl) {
                        // Set decay level as data attribute for CSS styling
                        if (tab.decay_level > 0) {
                            tabEl.setAttribute('data-decay', tab.decay_level);
                        } else {
                            tabEl.removeAttribute('data-decay');
                        }
                    }
                });
            }
        };

        // DOM references
        const sidebar = document.getElementById('sidebar');
        const chromeMain = document.getElementById('chromeMain');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarLogoToggle = document.getElementById('sidebarLogoToggle');
        const workspaceBadge = document.getElementById('workspaceBadge');

        // Sidebar state
        let sidebarOpen = false;

        // Right Sidebar references and state
        const rightSidebar = document.getElementById('rightSidebar');
        const rightSidebarClose = document.getElementById('rightSidebarClose');
        const rightSidebarDownloadsBtn = document.getElementById('rightSidebarDownloads');
        const rightSidebarHistoryBtn = document.getElementById('rightSidebarHistory');
        const rightSidebarHelpBtn = document.getElementById('rightSidebarHelp');
        let rightSidebarOpen = false;

        // Tab Actions Panel references and state
        const tabActionsPanel = document.getElementById('tabActionsPanel');
        const tabActionsFavicon = document.getElementById('tabActionsFavicon');
        const tabActionsTitle = document.getElementById('tabActionsTitle');
        const tabActionsPanelClose = document.getElementById('tabActionsPanelClose');
        const tabActionLock = document.getElementById('tabActionLock');
        const tabActionShelve = document.getElementById('tabActionShelve');
        const tabActionMove = document.getElementById('tabActionMove');
        const tabActionDuplicate = document.getElementById('tabActionDuplicate');
        const tabActionCopyUrl = document.getElementById('tabActionCopyUrl');
        const tabActionCloseOthers = document.getElementById('tabActionCloseOthers');
        const tabActionClose = document.getElementById('tabActionClose');
        let tabActionsPanelOpen = false;
        let tabActionsPanelTabId = null;

        let shelfItems = [];
        let shelfScope = 'workspace';
        let globalShelfCount = 0;
        let currentMode = 'zen';
        let findModalOpen = false;
        let findCaseSensitive = false;
        const findModal = document.getElementById('findModal');
        const findInput = document.getElementById('findInput');
        const findPrevBtn = document.getElementById('findPrevBtn');
        const findNextBtn = document.getElementById('findNextBtn');
        const findCaseBtn = document.getElementById('findCaseBtn');
        const findCloseBtn = document.getElementById('findCloseBtn');
        const findCountEl = document.getElementById('findCount');
        const toolbarMenuBtn = document.getElementById('toolbarMenuBtn');
        const toolbarActionPanel = document.getElementById('toolbarActionPanel');
        const toolbarDownloadsBtn = document.getElementById('toolbarDownloadsBtn');
        const toolbarHistoryBtn = document.getElementById('toolbarHistoryBtn');
        const downloadsPanel = document.getElementById('downloadsPanel');
        const downloadsList = document.getElementById('downloadsList');
        const downloadsBadge = document.getElementById('downloadsBadge');
        const clearDownloadsBtn = document.getElementById('clearDownloadsBtn');
        const historyPanel = document.getElementById('historyPanel');
        const historyList = document.getElementById('historyList');
        const historySearch = document.getElementById('historySearch');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        let shieldEnabled = true;
        let downloadsPanelOpen = false;
        let currentDownloads = [];
        let historyPanelOpen = false;
        let currentHistory = [];
        let toolbarActionOpen = false;
        let helpPanelOpen = false;
        const helpMenuBtn = document.getElementById('helpMenuBtn');
        const helpPanel = document.getElementById('helpPanel');
        let activeDownloadCount = 0;
        let shieldStats = { requests_blocked: 0, trackers_blocked: 0 };
        let draggingTabId = null;
        let draggingShelfId = null;

        let navState = { canGoBack: false, canGoForward: false };
        const contextMenu = document.getElementById('contextMenu');
        let contextMenuVisible = false;
        let activeContextTabId = null;

        const modeDescriptions = {
            essentials: 'Manual control, no automation',
            balanced: 'Smart suggestions, you confirm',
            zen: 'Full automation with undo'
        };

        // Collapsible section state (not persisted - resets on launch)
        const sectionStates = {
            workspaces: true,  // expanded by default
            shelf: true        // expanded by default
        };

        // Toggle a collapsible section
        function toggleSection(sectionName) {
            sectionStates[sectionName] = !sectionStates[sectionName];
            const header = document.querySelector(`[data-collapsible="${sectionName}"]`);
            if (!header) return;

            const section = header.closest('.sidebar-section');
            const content = section ? section.querySelector('.section-content') : null;
            if (!content) return;

            const isExpanded = sectionStates[sectionName];
            header.setAttribute('aria-expanded', isExpanded);

            if (isExpanded) {
                content.classList.remove('collapsed');
                // Set max-height for smooth animation
                content.style.maxHeight = content.scrollHeight + 'px';
                // After animation, remove max-height to allow dynamic sizing
                setTimeout(() => {
                    if (sectionStates[sectionName]) {
                        content.style.maxHeight = '';
                    }
                }, 250);
            } else {
                // First set current height explicitly for transition
                content.style.maxHeight = content.scrollHeight + 'px';
                // Force reflow
                content.offsetHeight;
                // Then collapse
                content.classList.add('collapsed');
            }
        }

        // Update workspace count display
        function updateWorkspaceCount() {
            const countEl = document.getElementById('workspaceCount');
            if (countEl) {
                countEl.textContent = currentWorkspaces.length;
            }
        }

        // Initialize collapsible section event listeners
        function initCollapsibleSections() {
            document.querySelectorAll('.section-header[data-collapsible]').forEach(header => {
                // Make focusable
                header.tabIndex = 0;

                header.addEventListener('click', (e) => {
                    // Don't toggle if clicking on child buttons (if any)
                    if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('section-collapse-btn')) {
                        return;
                    }
                    toggleSection(header.dataset.collapsible);
                });

                // Keyboard support: Enter or Space to toggle
                header.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleSection(header.dataset.collapsible);
                    }
                });
            });
        }

        // Sidebar resize state
        let isResizing = false;
        let resizeStartX = 0;
        let resizeStartWidth = 0;
        const COMPACT_THRESHOLD = 120;
        const SIDEBAR_MIN = 48;
        const SIDEBAR_MAX = 400;

        // Initialize sidebar resize functionality
        function initSidebarResize() {
            const resizeHandle = document.getElementById('sidebarResizeHandle');
            if (!resizeHandle) return;

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                resizeStartX = e.clientX;
                resizeStartWidth = sidebar.offsetWidth;
                sidebar.classList.add('resizing');
                resizeHandle.classList.add('dragging');
                document.body.style.cursor = 'ew-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const delta = e.clientX - resizeStartX;
                let newWidth = resizeStartWidth + delta;

                // Clamp to min/max
                newWidth = Math.max(SIDEBAR_MIN, Math.min(SIDEBAR_MAX, newWidth));

                sidebar.style.width = newWidth + 'px';
                updateSidebarMode(newWidth);

                // Update layout in real-time
                sendIpc('set_sidebar_width', { width: newWidth });
            });

            document.addEventListener('mouseup', () => {
                if (!isResizing) return;

                isResizing = false;
                sidebar.classList.remove('resizing');
                const resizeHandle = document.getElementById('sidebarResizeHandle');
                if (resizeHandle) resizeHandle.classList.remove('dragging');
                document.body.style.cursor = '';

                // Save width to settings (will implement later)
                const width = sidebar.offsetWidth;
                sendIpc('save_sidebar_width', { width });
            });

            // Double-click to reset to default width
            resizeHandle.addEventListener('dblclick', () => {
                sidebar.style.width = '220px';
                updateSidebarMode(220);
                sendIpc('save_sidebar_width', { width: 220 });
            });
        }

        // Update sidebar mode based on width
        function updateSidebarMode(width) {
            const isCompact = width <= COMPACT_THRESHOLD;
            sidebar.classList.toggle('compact', isCompact);
        }

        function updateFindCountText(count, index) {
            if (!findCountEl) {
                return;
            }
            if (count <= 0) {
                findCountEl.textContent = '0/0';
                return;
            }
            const displayIndex = Math.max(1, index + 1);
            findCountEl.textContent = `${displayIndex}/${count}`;
        }

        function openFindModal() {
            if (!findModal) {
                return;
            }
            if (!findModalOpen) {
                findModalOpen = true;
                findModal.classList.add('open');
                findModal.setAttribute('aria-hidden', 'false');
            }
            if (findInput) {
                setTimeout(() => {
                    findInput.focus();
                    findInput.select();
                }, 0);
            }
        }

        function closeFindModal(clearInput = false) {
            if (!findModal || !findModalOpen) {
                return;
            }
            findModalOpen = false;
            findModal.classList.remove('open');
            findModal.setAttribute('aria-hidden', 'true');
            if (findInput) {
                findInput.blur();
                if (clearInput) {
                    findInput.value = '';
                    updateFindCountText(0, -1);
                }
            }
        }

        // Click outside modal to close
        if (findModal) {
            findModal.addEventListener('click', (e) => {
                if (e.target === findModal) {
                    closeFindModal(true);
                    performFind('reset');
                }
            });
        }

        function performFind(direction = 'reset') {
            if (!findInput) {
                return;
            }
            const query = findInput.value.trim();
            if (!query) {
                sendIpc('find_in_page', {
                    query: '',
                    case_sensitive: findCaseSensitive,
                    direction: 'reset',
                });
                updateFindCountText(0, -1);
                return;
            }
            sendIpc('find_in_page', {
                query,
                case_sensitive: findCaseSensitive,
                direction,
            });
        }

        function renderContextMenu(items, x, y) {
            if (!contextMenu || !items || !items.length) {
                return;
            }
            contextMenu.innerHTML = items
                .map((item) => {
                    if (item.type === 'divider') {
                        return '<div class="context-menu-divider"></div>';
                    }
                    const disabled = item.disabled ? ' disabled' : '';
                    const dataAction = item.action ? ` data-action="${item.action}"` : '';
                    const tabAttr = item.tabId ? ` data-tab-id="${item.tabId}"` : '';
                    const workspaceAttr = item.workspaceId
                        ? ` data-workspace-id="${item.workspaceId}"`
                        : '';
                    const urlAttr = item.url ? ` data-url="${encodeURIComponent(item.url)}"` : '';
                    const textAttr = item.text ? ` data-text="${encodeURIComponent(item.text)}"` : '';
                    const icon = item.icon ? `<span class="icon">${item.icon}</span>` : '';
                    const tooltip = item.label ? ` title="${item.label}"` : '';
                    return `<button type="button" class="context-menu-item${disabled}"${dataAction}${tabAttr}${workspaceAttr}${urlAttr}${textAttr}${tooltip}>${icon}<span>${item.label}</span></button>`;
                })
                .join('');

            // Attach click handlers directly to buttons
            contextMenu.querySelectorAll('.context-menu-item').forEach(button => {
                button.onclick = (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    if (button.classList.contains('disabled')) {
                        return;
                    }
                    const action = button.dataset.action;
                    const tabId = button.dataset.tabId;
                    const workspaceId = button.dataset.workspaceId;
                    const url = button.dataset.url ? decodeURIComponent(button.dataset.url) : null;
                    const text = button.dataset.text ? decodeURIComponent(button.dataset.text) : null;
                    console.log('Button click:', action, tabId, workspaceId, url, text);
                    handleContextMenuAction(action, { tabId, workspaceId, url, text });
                };
            });

            const menuWidth = contextMenu.offsetWidth || 220;
            const menuHeight = contextMenu.offsetHeight || 200;
            const left = Math.max(8, Math.min(x, window.innerWidth - menuWidth - 8));
            const top = Math.max(8, Math.min(y, window.innerHeight - menuHeight - 8));
            contextMenu.style.left = `${left}px`;
            contextMenu.style.top = `${top}px`;
            contextMenu.classList.add('visible');
            contextMenuVisible = true;
        }

        function hideContextMenu() {
            if (!contextMenuVisible || !contextMenu) {
                return;
            }
            contextMenu.classList.remove('visible');
            contextMenuVisible = false;
            contextMenu.innerHTML = '';
        }

        function showTabContextMenu(event, tabId) {
            const tab = currentTabs.find((tab) => String(tab.id) === String(tabId));
            if (!tab) {
                return;
            }
            event.preventDefault();
            activeContextTabId = tabId;
            const tabIndex = currentTabs.findIndex((tab) => String(tab.id) === String(tabId));
            const items = [
                {
                    label: tab.locked ? 'Unlock' : 'Lock',
                    icon: tab.locked ? '' : '',
                    action: tab.locked ? 'unlock' : 'lock',
                    tabId,
                },
                { label: 'Shelf', icon: '', action: 'shelf', tabId },
                {
                    label: 'Duplicate',
                    icon: '',
                    action: 'duplicate',
                    tabId,
                    disabled: !tab.url,
                },
                { label: 'Close', icon: '', action: 'close', tabId },
                {
                    label: 'Close Others',
                    icon: '',
                    action: 'close_others',
                    tabId,
                    disabled: currentTabs.length <= 1,
                },
                {
                    label: 'Close Right',
                    icon: '',
                    action: 'close_right',
                    tabId,
                    disabled: tabIndex === currentTabs.length - 1,
                },
            ];

            // Add "Move to" as a single item if there are other workspaces
            const otherWorkspaces = currentWorkspaces.filter(ws => ws.id !== activeWorkspaceId);
            if (otherWorkspaces.length === 1) {
                items.push({
                    label: ` ${otherWorkspaces[0].name}`,
                    icon: '',
                    action: 'move',
                    tabId,
                    workspaceId: otherWorkspaces[0].id,
                });
            } else if (otherWorkspaces.length > 1) {
                // For multiple workspaces, just add first 2 to keep menu compact
                otherWorkspaces.slice(0, 2).forEach((ws) => {
                    items.push({
                        label: ` ${ws.name}`,
                        icon: '',
                        action: 'move',
                        tabId,
                        workspaceId: ws.id,
                    });
                });
            }

            items.push({
                label: 'Copy URL',
                icon: '',
                action: 'copy_link',
                tabId,
                disabled: !tab.url,
            });

            renderContextMenu(items, event.clientX, event.clientY);
        }

        function showPageContextMenu(event) {
            if (
                event.target.closest('#sidebar') ||
                event.target.closest('.downloads-panel') ||
                event.target.closest('.history-panel') ||
                event.target.closest('.toolbar-action-menu') ||
                event.target.closest('.context-menu')
            ) {
                return;
            }
            event.preventDefault();
            const urlValue = urlInput ? urlInput.value.trim() : '';
            const items = [
                {
                    label: 'Back',
                    action: 'go_back',
                    disabled: !navState.canGoBack,
                },
                {
                    label: 'Forward',
                    action: 'go_forward',
                    disabled: !navState.canGoForward,
                },
                { label: 'Reload', action: 'reload' },
                { type: 'divider' },
                { label: 'New Tab', action: 'new_tab' },
                {
                    label: 'Copy Page URL',
                    action: 'copy_url',
                    disabled: !urlValue,
                },
                {
                    label: 'Add Active Tab to Shelf',
                    action: 'shelf_active',
                    disabled: !activeTabId,
                },
            ];
            renderContextMenu(items, event.clientX, event.clientY);
            activeContextTabId = activeTabId;
        }

        function handleContextMenuAction(action, { tabId, workspaceId, url, text } = {}) {
            const normalizedTabId = tabId || activeContextTabId;
            switch (action) {
                case 'lock':
                case 'unlock':
                    if (normalizedTabId) {
                        sendIpc(
                            action === 'lock' ? 'lock_page' : 'unlock_page',
                            { tab_id: String(normalizedTabId) }
                        );
                    }
                    break;
                case 'shelf':
                case 'shelf_active':
                    if (normalizedTabId) {
                        sendIpc('add_to_shelf', { tab_id: String(normalizedTabId) });
                    }
                    break;
                case 'duplicate': {
                    const tab = currentTabs.find((t) => String(t.id) === String(normalizedTabId));
                    if (tab && tab.url) {
                        sendIpc('create_tab', { url: tab.url });
                    }
                    break;
                }
                case 'close': {
                    if (normalizedTabId) {
                        sendIpc('close_tab', { id: String(normalizedTabId) });
                    }
                    break;
                }
                case 'close_others': {
                    const tabsToClose = currentTabs
                        .filter((t) => String(t.id) !== String(normalizedTabId))
                        .map((t) => String(t.id));
                    tabsToClose.forEach((id) => sendIpc('close_tab', { id }));
                    break;
                }
                case 'close_right': {
                    const index = currentTabs.findIndex(
                        (t) => String(t.id) === String(normalizedTabId)
                    );
                    if (index !== -1) {
                        const tabsToClose = currentTabs
                            .slice(index + 1)
                            .map((t) => String(t.id));
                        tabsToClose.forEach((id) => sendIpc('close_tab', { id }));
                    }
                    break;
                }
                case 'move':
                    if (normalizedTabId && workspaceId) {
                        sendIpc('move_tab_to_workspace', {
                            tab_id: String(normalizedTabId),
                            workspace_id: workspaceId,
                        });
                        sendIpc('get_workspaces');
                        sendIpc('get_tabs');
                    }
                    break;
                case 'copy_link':
                case 'copy_url': {
                    const value =
                        action === 'copy_link'
                            ? (currentTabs.find((t) => String(t.id) === String(normalizedTabId)) || {})
                                  .url
                            : urlInput.value;
                    if (value) {
                        copyToClipboard(value);
                    }
                    break;
                }
                case 'go_back':
                case 'go_forward':
                case 'reload':
                    sendIpc(
                        action === 'reload'
                            ? 'reload'
                            : action === 'go_back'
                            ? 'go_back'
                            : 'go_forward'
                    );
                    break;
                case 'new_tab':
                    sendIpc('create_tab');
                    break;
                // Content context menu actions
                case 'copy_selection':
                    if (text) {
                        copyToClipboard(text);
                    }
                    break;
                case 'search_selection':
                    if (text) {
                        sendIpc('create_tab', { url: `https://duckduckgo.com/?q=${encodeURIComponent(text)}` });
                    }
                    break;
                case 'open_link_new_tab':
                case 'open_image_new_tab':
                    if (url) {
                        sendIpc('create_tab', { url: url });
                    }
                    break;
                case 'copy_link_url':
                case 'copy_image_url':
                case 'copy_page_url':
                    if (url) {
                        copyToClipboard(url);
                    }
                    break;
                default:
                    break;
            }
            hideContextMenu();
        }

        if (contextMenu) {
            contextMenu.addEventListener('click', (event) => {
                event.stopPropagation();
                const button = event.target.closest('.context-menu-item');
                console.log('Context menu click:', event.target, button);
                if (!button || button.classList.contains('disabled')) {
                    console.log('Button disabled or not found');
                    return;
                }
                const action = button.dataset.action;
                const tabId = button.dataset.tabId;
                const workspaceId = button.dataset.workspaceId;
                const url = button.dataset.url ? decodeURIComponent(button.dataset.url) : null;
                const text = button.dataset.text ? decodeURIComponent(button.dataset.text) : null;
                console.log('Executing action:', action, 'tabId:', tabId, 'workspaceId:', workspaceId, 'url:', url, 'text:', text);
                handleContextMenuAction(action, { tabId, workspaceId, url, text });
            });
            contextMenu.addEventListener('contextmenu', (event) => {
                event.preventDefault();
            });
        }

        document.addEventListener('click', (event) => {
            // Exit focus mode when clicking any interactive element (except reveal zone)
            if (document.body.classList.contains('focus-mode') || document.body.classList.contains('peek-mode')) {
                const isInteractive = event.target.closest('button, .nav-btn, .toolbar-btn, input, a, .sidebar-btn, .workspace-item, .tab');
                const isRevealZone = event.target.closest('.focus-reveal-zone');
                const isFocusToggle = event.target.closest('#focusTestBtn, #peekExitBtn');

                // If clicking an interactive element (not the focus toggle buttons or reveal zone), exit focus mode
                if (isInteractive && !isRevealZone && !isFocusToggle) {
                    console.log('[Focus] Exiting focus mode due to UI interaction');
                    sendIpc('exit_focus_mode', {});
                }
            }

            if (contextMenuVisible && !event.target.closest('.context-menu')) {
                hideContextMenu();
            }
        });

        window.addEventListener('resize', hideContextMenu);
        window.addEventListener('scroll', hideContextMenu, true);

        document.addEventListener('contextmenu', (event) => {
            console.log('Contextmenu event:', event.target, event.target.className);
            const tab = event.target.closest('.tab');
            console.log('Found tab:', tab, tab ? tab.dataset.id : 'none');
            if (tab) {
                event.preventDefault();
                // Show Tab Actions Panel instead of context menu
                console.log('Calling showTabActionsPanel with id:', tab.dataset.id);
                showTabActionsPanel(tab.dataset.id);
                return;
            }
            if (event.target.closest('#sidebar')) {
                hideContextMenu();
                return;
            }
            showPageContextMenu(event);
        });

        // IPC helper
        function sendIpc(cmd, data = {}) {
            const message = { cmd, ...data };
            window.ipc.postMessage(JSON.stringify(message));
        }

        // Clipboard helper with fallback methods
        async function copyToClipboard(text) {
            // Method 1: Modern Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(text);
                    console.log('Copied via Clipboard API:', text);
                    return true;
                } catch (err) {
                    console.warn('Clipboard API failed:', err);
                }
            }

            // Method 2: execCommand fallback
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                textarea.style.top = '-9999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                const success = document.execCommand('copy');
                document.body.removeChild(textarea);
                if (success) {
                    console.log('Copied via execCommand:', text);
                    return true;
                }
            } catch (err) {
                console.warn('execCommand copy failed:', err);
            }

            console.error('All clipboard methods failed for:', text);
            return false;
        }

        if (findInput) {
            findInput.addEventListener('input', () => {
                if (findModalOpen) {
                    performFind('reset');
                }
            });
            findInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performFind(e.shiftKey ? 'prev' : 'next');
                }
            });
        }
        if (findPrevBtn) {
            findPrevBtn.addEventListener('click', () => performFind('prev'));
        }
        if (findNextBtn) {
            findNextBtn.addEventListener('click', () => performFind('next'));
        }
        if (findCaseBtn) {
            findCaseBtn.addEventListener('click', () => {
                findCaseSensitive = !findCaseSensitive;
                findCaseBtn.classList.toggle('active', findCaseSensitive);
                if (findModalOpen) {
                    performFind('reset');
                }
            });
        }
        if (findCloseBtn) {
            findCloseBtn.addEventListener('click', () => {
                closeFindModal(true);
                performFind('reset');
            });
        }

        // Toggle sidebar (mutual exclusivity with right sidebar)
        function toggleSidebar() {
            sidebarOpen = !sidebarOpen;
            sidebar.classList.toggle('collapsed', !sidebarOpen);
            // Close right sidebar if opening left sidebar
            if (sidebarOpen && rightSidebarOpen) {
                rightSidebarOpen = false;
                rightSidebar.classList.add('collapsed');
                sendIpc('set_right_panel_open', { open: false });
            }
            syncSidebarLayout();
            console.log('Sidebar:', sidebarOpen ? 'open' : 'closed');
        }

        function syncSidebarLayout() {
            if (sidebarOpen) {
                // When opening, send the current width
                const width = parseInt(sidebar.style.width) || 220;
                sendIpc('set_sidebar_width', { width: width });
            } else {
                // When closing, send width 0
                sendIpc('set_sidebar_width', { width: 0 });
            }
        }

        // Toggle right sidebar (mutual exclusivity with left sidebar)
        function toggleRightSidebar() {
            rightSidebarOpen = !rightSidebarOpen;
            rightSidebar.classList.toggle('collapsed', !rightSidebarOpen);
            // Close left sidebar if opening right sidebar
            if (rightSidebarOpen && sidebarOpen) {
                sidebarOpen = false;
                sidebar.classList.add('collapsed');
                sendIpc('set_sidebar_open', { open: false });
            }
            syncRightSidebarLayout();
            console.log('Right Sidebar:', rightSidebarOpen ? 'open' : 'closed');
        }

        function syncRightSidebarLayout() {
            sendIpc('set_right_panel_open', { open: rightSidebarOpen });
        }

        // Tab Actions Panel functions
        function showTabActionsPanel(tabId) {
            console.log('showTabActionsPanel called with tabId:', tabId, 'type:', typeof tabId);
            console.log('currentTabs:', currentTabs.map(t => ({ id: t.id, type: typeof t.id })));
            const tab = currentTabs.find(t => String(t.id) === String(tabId));
            console.log('Found tab in currentTabs:', tab);
            if (!tab) {
                console.log('Tab not found, returning');
                return;
            }

            // Store the tab ID for actions
            tabActionsPanelTabId = tabId;

            // Update panel info
            if (tabActionsFavicon) {
                tabActionsFavicon.src = tab.favicon || '';
                tabActionsFavicon.style.display = tab.favicon ? 'block' : 'none';
            }
            if (tabActionsTitle) {
                tabActionsTitle.textContent = tab.title || 'Untitled';
            }

            // Update lock button text
            if (tabActionLock) {
                const lockLabel = tabActionLock.querySelector('.label');
                if (lockLabel) {
                    lockLabel.textContent = tab.locked ? 'Unlock' : 'Lock';
                }
            }

            // Show panel and expand chrome
            console.log('tabActionsPanel element:', tabActionsPanel);
            if (tabActionsPanel) {
                tabActionsPanel.classList.add('visible');
                console.log('Added visible class to panel');
            }
            console.log('tabActionsPanelOpen:', tabActionsPanelOpen);
            if (!tabActionsPanelOpen) {
                console.log('Sending expand_chrome_small IPC');
                sendIpc('expand_chrome_small');
                tabActionsPanelOpen = true;
            }
        }

        function hideTabActionsPanel() {
            if (tabActionsPanel) {
                tabActionsPanel.classList.remove('visible');
            }
            if (tabActionsPanelOpen) {
                sendIpc('collapse_chrome');
                tabActionsPanelOpen = false;
            }
            tabActionsPanelTabId = null;
        }

        function requestShelf() {
            sendIpc('get_shelf', { scope: shelfScope });
        }

        // Open command palette (now just opens find modal)
        function openCommandPalette() {
            openFindModal();
        }

        // Render workspaces in sidebar
        function renderSidebarWorkspaces() {
            const list = document.getElementById('sidebarWorkspaceList');
            if (!list) return;

            // Handle empty workspaces state
            if (!currentWorkspaces || currentWorkspaces.length === 0) {
                list.innerHTML = `
                    <div class="workspace-empty">
                        <div class="workspace-empty-icon"></div>
                        <div class="workspace-empty-title">No workspaces yet</div>
                        <div class="workspace-empty-description">Create a workspace to organize your tabs by context</div>
                        <button class="workspace-empty-btn" onclick="createWorkspace()">
                            + New Workspace
                        </button>
                    </div>
                `;
                updateWorkspaceCount();
                return;
            }

            // Only auto-expand if the previously expanded workspace no longer exists (was deleted)
            // Don't auto-expand if user explicitly collapsed (expandedWorkspaceId === null)
            if (expandedWorkspaceId && !currentWorkspaces.some(ws => ws.id === expandedWorkspaceId)) {
                const activeWs = currentWorkspaces.find(ws => ws.is_active);
                expandedWorkspaceId = activeWs ? activeWs.id : null;
            }

            const allowWorkspaceHighlight = shelfScope !== 'all';

            const workspaceEntries = currentWorkspaces.map((ws) => {
                const icon = (ws.name || 'W').trim().charAt(0).toUpperCase() || 'W';
                const lockCount = Number(ws.locked_count || 0);
                const lockBadge = lockCount > 0
                    ? `<span class="workspace-lock-count" title="${lockCount} locked tab${lockCount === 1 ? '' : 's'}">${lockCount}</span>`
                    : '';
                const isExpanded = expandedWorkspaceId === ws.id;
                const tabList = (ws.tabs || []).map(tab => {
                    const tabIcon = tab.locked ? '' : '';
                    const decayLevel = tab.decay_level || 0;
                    const lockedClass = tab.locked ? ' locked' : '';
                    return `
                        <div class="workspace-tab ${tab.is_active ? 'active' : ''}${lockedClass}" data-tab-id="${tab.id}" data-workspace-id="${ws.id}" data-decay="${decayLevel}">
                            <span class="workspace-tab-decay-indicator"></span>
                            <span class="workspace-tab-title">${escapeHtml(tab.title)}</span>
                            <button type="button" class="workspace-tab-lock-btn ${tab.locked ? 'locked' : ''}" data-locked="${tab.locked ? '1' : '0'}" title="${tab.locked ? 'Unlock tab' : 'Lock tab'}">
                                ${tabIcon}
                            </button>
                        </div>
                    `;
                }).join('') || '<div class="workspace-tab-empty">No pages yet</div>';

                return `
                    <div class="workspace-entry" data-id="${ws.id}">
                        <div class="workspace-item ${ws.is_active && allowWorkspaceHighlight ? 'active' : ''}" data-id="${ws.id}" data-name="${escapeHtml(ws.name)}">
                            <span class="workspace-icon">${escapeHtml(icon)}</span>
                            <span class="workspace-name">${escapeHtml(ws.name)}</span>
                            <span class="workspace-tab-count" title="${(ws.tab_count || 0)} page${(ws.tab_count || 0) === 1 ? '' : 's'}">${ws.tab_count || 0}</span>
                            ${lockBadge}
                            ${ws.is_suspended ? '<span class="workspace-suspended">Z</span>' : ''}
                            <div class="workspace-actions">
                                <button class="workspace-rename-btn" title="Rename workspace">&#9998;</button>
                                <button class="workspace-delete-btn" title="Delete workspace">&#10005;</button>
                            </div>
                            <button type="button" class="workspace-expander" aria-expanded="${isExpanded}">
                                ${isExpanded ? '' : ''}
                            </button>
                        </div>
                        <div class="workspace-tab-list ${isExpanded ? 'open' : ''}">
                            ${tabList}
                        </div>
                    </div>
                `;
            }).join('');

            const shelvedCount = Number(globalShelfCount || 0);
            const shelvedItem = `
                <div class="workspace-item ${shelfScope === 'all' ? 'active' : ''}" data-shelf="all" data-name="Shelved">
                    <span class="workspace-icon">S</span>
                    <span class="workspace-name">Shelved</span>
                    <span class="workspace-tab-count" title="${shelvedCount} shelved page${shelvedCount === 1 ? '' : 's'}">${shelvedCount}</span>
                </div>
            `;

            list.innerHTML = workspaceEntries + shelvedItem;

            list.querySelectorAll('.workspace-entry').forEach(wrapper => {
                const workspaceItem = wrapper.querySelector('.workspace-item');
                if (!workspaceItem) return;
                const workspaceId = wrapper.dataset.id;
                const expander = workspaceItem.querySelector('.workspace-expander');
                const renameBtn = workspaceItem.querySelector('.workspace-rename-btn');
                const deleteBtn = workspaceItem.querySelector('.workspace-delete-btn');
                const tabsContainer = wrapper.querySelector('.workspace-tab-list');

                if (renameBtn) {
                    renameBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        startWorkspaceRename(workspaceItem);
                    });
                }

                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (!workspaceId) return;

                        if (deleteBtn.dataset.confirming === 'true') {
                            sendIpc('delete_workspace', { id: workspaceId });
                            return;
                        }

                        deleteBtn.dataset.confirming = 'true';
                        deleteBtn.innerHTML = '&#10003;';
                        deleteBtn.title = 'Click again to confirm delete';
                        deleteBtn.classList.add('confirm-delete');

                        setTimeout(() => {
                            deleteBtn.dataset.confirming = 'false';
                            deleteBtn.innerHTML = '&#10005;';
                            deleteBtn.title = 'Delete workspace';
                            deleteBtn.classList.remove('confirm-delete');
                        }, 3000);
                    });
                }

                workspaceItem.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    startWorkspaceRename(workspaceItem);
                });

                if (workspaceId) {
                    workspaceItem.addEventListener('click', () => {
                        shelfScope = 'workspace';
                        expandedWorkspaceId = workspaceId;
                        renderSidebarWorkspaces();
                        sendIpc('activate_workspace', { id: workspaceId });
                    });

                    workspaceItem.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        workspaceItem.classList.add('workspace-drop-target');
                    });

                    workspaceItem.addEventListener('dragleave', () => {
                        workspaceItem.classList.remove('workspace-drop-target');
                    });

                    workspaceItem.addEventListener('drop', (e) => {
                        e.preventDefault();
                        workspaceItem.classList.remove('workspace-drop-target');
                        handleWorkspaceDrop(workspaceId);
                    });
                }

                if (expander) {
                    expander.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (expandedWorkspaceId === workspaceId) {
                            expandedWorkspaceId = null;
                        } else {
                            expandedWorkspaceId = workspaceId;
                        }
                        renderSidebarWorkspaces();
                    });
                }

                tabsContainer?.querySelectorAll('.workspace-tab').forEach(tabEl => {
                    const tabId = tabEl.dataset.tabId;
                    if (!tabId) return;

                    tabEl.addEventListener('click', () => {
                        sendIpc('activate_tab', { id: tabId });
                    });

                    const lockBtn = tabEl.querySelector('.workspace-tab-lock-btn');
                    if (lockBtn) {
                        lockBtn.addEventListener('click', (evt) => {
                            evt.stopPropagation();
                            const locked = lockBtn.dataset.locked === '1';
                            const action = locked ? 'unlock_page' : 'lock_page';
                            sendIpc(action, { tab_id: tabId });
                            lockBtn.dataset.locked = locked ? '0' : '1';
                            lockBtn.classList.toggle('locked', !locked);
                            lockBtn.textContent = locked ? '' : '';
                            lockBtn.title = locked ? 'Lock tab' : 'Unlock tab';
                        });
                    }
                });
            });

            const shelvedEl = list.querySelector('.workspace-item[data-shelf="all"]');
            if (shelvedEl) {
                shelvedEl.addEventListener('click', () => {
                    shelfScope = 'all';
                    renderSidebarWorkspaces();
                    requestShelf();
                });
            }

            // Update workspace count in collapsible header
            updateWorkspaceCount();
        }

        function startWorkspaceRename(el) {
            const wsId = el.dataset.id;
            const nameSpan = el.querySelector('.workspace-name');
            if (!nameSpan || !wsId) return;

            const currentName = nameSpan.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'workspace-rename-input';

            nameSpan.style.display = 'none';
            nameSpan.parentNode.insertBefore(input, nameSpan.nextSibling);
            input.focus();
            input.select();

            const finishRename = (save) => {
                const newName = input.value.trim();
                input.remove();
                nameSpan.style.display = '';

                if (save && newName && newName !== currentName) {
                    sendIpc('rename_workspace', { id: wsId, name: newName });
                }
            };

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishRename(true);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    finishRename(false);
                }
            });

            input.addEventListener('blur', () => {
                finishRename(true);
            });
        }

        function handleWorkspaceDrop(workspaceId) {
            if (!workspaceId) return;

            if (draggingTabId) {
                sendIpc('move_tab_to_workspace', {
                    tab_id: String(draggingTabId),
                    workspace_id: workspaceId,
                });
            } else if (draggingShelfId) {
                sendIpc('restore_from_shelf', {
                    id: draggingShelfId,
                    workspace_id: workspaceId,
                });
            }

            draggingTabId = null;
            draggingShelfId = null;
            shelfScope = 'workspace';
            requestShelf();
        }

        function updateWorkspaceBadge() {
            if (!workspaceBadge) {
                return;
            }
            // Update badge to show first letter of active workspace
            const activeWs = currentWorkspaces.find(ws => ws.is_active);
            if (activeWs) {
                const firstLetter = (activeWs.name || 'W').trim().charAt(0).toUpperCase() || 'W';
                workspaceBadge.textContent = firstLetter;
                workspaceBadge.title = activeWs.name;
            }
            // Show badge only if there are multiple workspaces
            workspaceBadge.style.display = currentWorkspaces.length > 1 ? 'flex' : 'none';
        }

        // Update workspace tab count when tabs change
        function updateWorkspaceTabCount() {
            const activeWs = currentWorkspaces.find(ws => ws.id === activeWorkspaceId);
            if (activeWs) {
                activeWs.tab_count = currentTabs.length;
                renderSidebarWorkspaces();
            }
        }

        // Render shelf items
        function updateShelfTitle() {
            const title = document.getElementById('shelfTitle');
            if (!title) return;

            if (shelfScope === 'all') {
                title.textContent = 'The Shelf - Shelved';
                return;
            }

            const activeWs = currentWorkspaces.find(ws => ws.id === activeWorkspaceId);
            title.textContent = activeWs ? `The Shelf - ${activeWs.name}` : 'The Shelf';
        }

        function getDomain(url) {
            try {
                return new URL(url).hostname.replace('www.', '');
            } catch {
                return url;
            }
        }

        function formatShelfAge(addedAt) {
            const SHELF_EXPIRY_DAYS = 7;
            if (!addedAt) {
                return { age: 'just now', decayLevel: 0, daysRemaining: SHELF_EXPIRY_DAYS };
            }
            const now = Math.floor(Date.now() / 1000);
            const diff = Math.max(0, now - Number(addedAt));
            const minutes = Math.floor(diff / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const daysRemaining = Math.max(0, SHELF_EXPIRY_DAYS - days);

            if (minutes < 1) {
                return { age: 'just now', decayLevel: 0, daysRemaining };
            }
            if (minutes < 60) {
                return { age: `${minutes}m`, decayLevel: 0, daysRemaining };
            }
            if (hours < 24) {
                return { age: `${hours}h`, decayLevel: 1, daysRemaining };
            }
            if (days < 3) {
                return { age: `${days}d`, decayLevel: 2, daysRemaining };
            }
            if (days < 7) {
                return { age: `${days}d`, decayLevel: 3, daysRemaining };
            }
            return { age: `${days}d`, decayLevel: 4, daysRemaining: 0 };
        }

        function normalizeShelfItem(item) {
            const url = item.url || '';
            const title = item.title && item.title.trim() !== ''
                ? item.title
                : getDomain(url) || 'New Tab';
            const domain = getDomain(url) || '';
            const timing = formatShelfAge(item.added_at);
            return {
                id: item.id,
                url,
                title,
                domain,
                age: timing.age,
                decayLevel: timing.decayLevel,
                daysRemaining: timing.daysRemaining,
                workspace: item.workspace || ''
            };
        }

        function renderShelf() {
            const list = document.getElementById('shelfList');
            const countEl = document.getElementById('shelfCount');
            if (!list || !countEl) return;

            updateShelfTitle();

            const items = shelfItems.map(normalizeShelfItem);
            const displayCount = shelfScope === 'all'
                ? Number(globalShelfCount || items.length)
                : items.length;

            countEl.textContent = displayCount;

            if (items.length === 0) {
                const emptyTitle = shelfScope === 'all'
                    ? 'Your shelf is empty'
                    : 'No items in this workspace';
                const emptyDesc = shelfScope === 'all'
                    ? 'Shelved tabs appear here. They auto-expire after 7 days unless pinned.'
                    : 'Park tabs here to revisit later. They\'ll fade over time.';
                list.innerHTML = `
                    <div class="shelf-empty">
                        <div class="shelf-empty-icon"></div>
                        <div class="shelf-empty-title">${emptyTitle}</div>
                        <div class="shelf-empty-description">${emptyDesc}</div>
                        <div class="shelf-empty-hint">Drag tabs here or use <kbd>K</kbd></div>
                    </div>
                `;
                return;
            }

            list.innerHTML = items.map(item => {
                const decayClass = item.decayLevel >= 4
                    ? 'expiring'
                    : item.decayLevel >= 2
                        ? 'decaying'
                        : '';
                const subtitle = shelfScope === 'all' && item.workspace
                    ? `${escapeHtml(item.workspace)} - ${escapeHtml(item.domain)}`
                    : escapeHtml(item.domain || '');
                const tooltipText = item.daysRemaining <= 0
                    ? 'Expires soon!'
                    : item.daysRemaining === 1
                        ? '1 day remaining'
                        : `${item.daysRemaining} days remaining`;
                const tooltipWarning = item.daysRemaining <= 1 ? 'warning' : '';
                return `
                    <div class="shelf-item ${decayClass}" data-id="${item.id}" draggable="true">
                        <div class="decay-tooltip ${tooltipWarning}">${tooltipText}</div>
                        <div class="shelf-item-header">
                            <div class="shelf-favicon"></div>
                            <div class="shelf-item-info">
                                <div class="shelf-item-title">${escapeHtml(item.title)}</div>
                                <div class="shelf-item-url">${subtitle}</div>
                            </div>
                        </div>
                        <div class="shelf-item-footer">
                            <span class="shelf-age ${item.decayLevel >= 4 ? 'warning' : ''}">
                                ${item.decayLevel >= 4 ? 'Expiring ' : ''}${item.age || 'just now'}
                            </span>
                            <div class="decay-indicator" data-level="${item.decayLevel || 0}"></div>
                        </div>
                    </div>
                `;
            }).join('');

            list.querySelectorAll('.shelf-item').forEach(el => {
                const item = shelfItems.find(i => i.id === el.dataset.id);
                if (!item) return;

                el.addEventListener('click', () => {
                    sendIpc('restore_from_shelf', { id: item.id });
                    requestShelf();
                });

                el.addEventListener('dragstart', (e) => {
                    draggingShelfId = item.id;
                    if (e.dataTransfer) {
                        e.dataTransfer.setData('text/plain', `shelf:${item.id}`);
                        e.dataTransfer.effectAllowed = 'move';
                    }
                });

                el.addEventListener('dragend', () => {
                    draggingShelfId = null;
                });
            });
        }

        function shelveTabById(tabId) {
            const tab = currentTabs.find(t => String(t.id) === String(tabId));
            if (!tab || !tab.url) return;
            if (tab.url === 'about:blank' || tab.url === 'hiwave://newtab') return;
            sendIpc('add_to_shelf', { tab_id: String(tabId) });
            requestShelf();
        }

        function shelveActiveTab() {
            if (!activeTabId) return;
            shelveTabById(activeTabId);
        }

        // Initialize mode selector
        function initModeSelector() {
            const selector = document.getElementById('modeSelector');
            const description = document.getElementById('modeDescription');
            if (!selector || !description) return;

            selector.value = currentMode;
            selector.className = `mode-selector ${currentMode}`;

            selector.addEventListener('change', (e) => {
                currentMode = e.target.value;
                selector.className = `mode-selector ${currentMode}`;
                description.textContent = modeDescriptions[currentMode];
                sendIpc('set_mode', { mode: currentMode });
                console.log('Mode changed to:', currentMode);
            });
        }

        // Initialize shelf drag and drop
        function initShelfDragDrop() {
            const shelfSection = document.querySelector('.shelf-section');
            const dropHint = document.getElementById('shelfDropHint');
            if (!shelfSection || !dropHint) return;

            shelfSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (e.dataTransfer) {
                    e.dataTransfer.dropEffect = 'move';
                }
                dropHint.classList.add('drag-over');
            });

            shelfSection.addEventListener('dragleave', (e) => {
                if (!shelfSection.contains(e.relatedTarget)) {
                    dropHint.classList.remove('drag-over');
                }
            });

            shelfSection.addEventListener('drop', (e) => {
                e.preventDefault();
                dropHint.classList.remove('drag-over');
                const tabId = e.dataTransfer ? e.dataTransfer.getData('text/plain') : '';
                const resolvedId = tabId || draggingTabId;
                if (resolvedId) {
                    shelveTabById(resolvedId);
                }
                draggingTabId = null;
            });
        }

        function updateShieldDisplay() {
            const shieldBtn = document.getElementById('shieldBtn');
            const shieldCount = document.getElementById('shieldCount');
            const sidebarBadge = document.getElementById('sidebarShieldBadge');
            const sidebarStatus = document.getElementById('sidebarShieldStatus');

            const count = (shieldStats.requests_blocked || 0) + (shieldStats.trackers_blocked || 0);
            if (shieldCount) {
                shieldCount.textContent = count;
            }
            if (sidebarBadge) {
                sidebarBadge.textContent = count;
            }

            if (shieldBtn) {
                if (shieldEnabled) {
                    shieldBtn.classList.remove('disabled');
                    shieldBtn.title = `Shield Active\n${shieldStats.requests_blocked} requests blocked\n${shieldStats.trackers_blocked} trackers blocked`;
                } else {
                    shieldBtn.classList.add('disabled');
                    shieldBtn.title = 'Shield Disabled - Click to enable';
                }
            }

            if (sidebarStatus) {
                if (shieldEnabled) {
                    sidebarStatus.classList.add('shield-status');
                } else {
                    sidebarStatus.classList.remove('shield-status');
                }
            }
        }

        function toggleShield() {
            shieldEnabled = !shieldEnabled;
            sendIpc('toggle_shield', { enabled: shieldEnabled });
            updateShieldDisplay();
        }

        // Blocklist state
        let blockedDomains = [];
        let blocklistDropdownOpen = false;

        // Fetch and display blocklist
        function fetchBlocklist() {
            sendIpc('get_blocklist');
        }

        function updateDownloadsBadge() {
            if (!downloadsBadge) {
                return;
            }
            if (activeDownloadCount > 0) {
                downloadsBadge.textContent = activeDownloadCount;
                downloadsBadge.classList.remove('hidden');
            } else {
                downloadsBadge.classList.add('hidden');
            }
        }

        function formatDownloadStatus(status) {
            switch (status) {
                case 'completed':
                    return 'Completed';
                case 'failed':
                    return 'Failed';
                case 'cancelled':
                    return 'Cancelled';
                default:
                    return 'In progress';
            }
        }

        function escapeAttr(value = '') {
            return value.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function handleDownloadAction(event) {
            event.stopPropagation();
            const button = event.currentTarget;
            if (!button) return;
            const action = button.dataset.action;
            const path = button.dataset.path;
            if (!path) return;
            if (action === 'show') {
                sendIpc('show_download_in_folder', { path });
            } else if (action === 'open') {
                sendIpc('open_download', { path });
            }
        }

        function renderDownloadsList(downloads) {
            currentDownloads = Array.isArray(downloads) ? downloads : [];
            // Also update right sidebar if it exists
            if (typeof renderRightDownloadsList === 'function') {
                renderRightDownloadsList();
            }
            if (!downloadsList) {
                return;
            }
            if (currentDownloads.length === 0) {
                downloadsList.innerHTML = '<div class="download-empty">No downloads yet</div>';
                return;
            }
            downloadsList.innerHTML = currentDownloads
                .map((download) => {
                    const fileName = download.file_name || 'Download';
                    const url = download.url || '';
                    const path = download.path || '';
                    const safePath = escapeAttr(path);
                    const hasPath = Boolean(path);
                    const statusText = formatDownloadStatus(download.status);
                    return `
                        <div class="download-item">
                            <div class="download-item-main">
                                <span class="download-name">${escapeHtml(fileName)}</span>
                                <span class="download-status">${statusText}</span>
                            </div>
                            <div class="download-url-line">${escapeHtml(url)}</div>
                            <div class="download-actions">
                                <button class="download-action" data-action="show" data-path="${safePath}" ${hasPath ? '' : 'disabled'}>Show in folder</button>
                                <button class="download-action" data-action="open" data-path="${safePath}" ${hasPath ? '' : 'disabled'}>Open file</button>
                            </div>
                        </div>
                    `;
                })
                .join('');
            downloadsList.querySelectorAll('.download-action').forEach((btn) => {
                btn.addEventListener('click', handleDownloadAction);
            });
        }

        let chromePanelOpenCount = 0;

        function expandChromePanel() {
            if (chromePanelOpenCount === 0) {
                sendIpc('expand_chrome');
            }
            chromePanelOpenCount += 1;
        }

        function collapseChromePanel() {
            if (chromePanelOpenCount === 0) {
                return;
            }
            chromePanelOpenCount -= 1;
            if (chromePanelOpenCount === 0) {
                sendIpc('collapse_chrome');
            }
        }

        function showDownloadsPanel() {
            if (!downloadsPanel) return;
            hideHistoryPanel();
            if (!downloadsPanelOpen) {
                expandChromePanel();
            }
            downloadsPanel.classList.remove('hidden');
            downloadsPanelOpen = true;
        }

        function hideDownloadsPanel() {
            if (!downloadsPanel) return;
            if (!downloadsPanelOpen) return;
            downloadsPanel.classList.add('hidden');
            downloadsPanelOpen = false;
            collapseChromePanel();
        }

        function toggleDownloadsPanel() {
            if (downloadsPanelOpen) {
                hideDownloadsPanel();
            } else {
                showDownloadsPanel();
            }
        }

        function showHistoryPanel() {
            if (!historyPanel) return;
            hideDownloadsPanel();
            if (!historyPanelOpen) {
                expandChromePanel();
            }
            historyPanel.classList.remove('hidden');
            historyPanelOpen = true;
            if (historySearch) {
                historySearch.focus();
            }
            sendIpc('get_visit_history');
        }

        function hideHistoryPanel() {
            if (!historyPanel) return;
            if (!historyPanelOpen) return;
            historyPanel.classList.add('hidden');
            historyPanelOpen = false;
            collapseChromePanel();
        }

        function toggleHistoryPanel() {
            if (historyPanelOpen) {
                hideHistoryPanel();
            } else {
                showHistoryPanel();
            }
        }

        function showToolbarActionPanel() {
            if (!toolbarActionPanel) return;
            toolbarActionPanel.classList.remove('hidden');
            toolbarActionOpen = true;
        }

        function hideToolbarActionPanel() {
            if (!toolbarActionPanel) return;
            if (!toolbarActionOpen) return;
            toolbarActionPanel.classList.add('hidden');
            toolbarActionOpen = false;
        }

        function toggleToolbarActionPanel() {
            if (toolbarActionOpen) {
                hideToolbarActionPanel();
            } else {
                hideDownloadsPanel();
                hideHistoryPanel();
                hideHelpPanel();
                showToolbarActionPanel();
            }
        }

        function showHelpPanel() {
            if (!helpPanel) return;
            helpPanel.classList.remove('hidden');
            helpPanelOpen = true;
        }

        function hideHelpPanel() {
            if (!helpPanel) return;
            if (!helpPanelOpen) return;
            helpPanel.classList.add('hidden');
            helpPanelOpen = false;
        }

        function toggleHelpPanel() {
            if (helpPanelOpen) {
                hideHelpPanel();
            } else {
                hideDownloadsPanel();
                hideHistoryPanel();
                hideToolbarActionPanel();
                showHelpPanel();
            }
        }

        function formatHistoryTimestamp(timestamp) {
            if (!timestamp) {
                return '';
            }
            const date = new Date(timestamp * 1000);
            return date.toLocaleString();
        }

        function renderHistoryList() {
            // Also update right sidebar if it exists
            if (typeof renderRightHistoryList === 'function') {
                renderRightHistoryList();
            }
            if (!historyList) return;
            const query = historySearch ? historySearch.value.trim().toLowerCase() : '';
            let entries = Array.isArray(currentHistory) ? currentHistory.slice() : [];
            if (query) {
                entries = entries.filter((entry) => {
                    const title = entry.title || '';
                    const workspace = entry.workspace || '';
                    return (
                        title.toLowerCase().includes(query) ||
                        entry.url.toLowerCase().includes(query) ||
                        workspace.toLowerCase().includes(query)
                    );
                });
            }

            if (!entries.length) {
                historyList.innerHTML = '<div class="history-empty">No history recorded yet</div>';
                return;
            }

            historyList.innerHTML = entries
                .map((entry) => {
                    const title = entry.title && entry.title !== 'New Tab' ? entry.title : entry.url;
                    const urlText = entry.url;
                    const countLabel = entry.count > 1 ? `${entry.count} visits` : '1 visit';
                    const workspaceBadge = entry.workspace
                        ? `<span class="history-item-workspace">${escapeHtml(entry.workspace)}</span>`
                        : '';
                    return `
                        <div class="history-item" data-url="${escapeHtml(urlText)}">
                            <div class="history-item-title">${escapeHtml(title)}</div>
                            <div class="history-item-url">${escapeHtml(urlText)}</div>
                            <div class="history-item-meta">
                                <span>${formatHistoryTimestamp(entry.timestamp)}</span>
                                <span class="history-meta-right">
                                    <span class="history-item-count">${countLabel}</span>
                                    ${workspaceBadge}
                                </span>
                            </div>
                        </div>
                    `;
                })
                .join('');

            historyList.querySelectorAll('.history-item').forEach((item) => {
                item.addEventListener('click', () => {
                    const targetUrl = item.dataset.url;
                    if (targetUrl) {
                        sendIpc('navigate', { url: targetUrl });
                        hideHistoryPanel();
                    }
                });
            });
        }

        function renderBlocklist(domains) {
            blockedDomains = domains || [];
            const content = document.getElementById('blocklistContent');
            const badge = document.getElementById('sidebarBlocklistBadge');

            if (badge) {
                badge.textContent = blockedDomains.length;
            }

            if (!content) return;

            if (blockedDomains.length === 0) {
                content.innerHTML = '<div class="blocklist-empty">No sites blocked yet.<br>Click the shield icon on a tab to block its domain.</div>';
                return;
            }

            content.innerHTML = blockedDomains.map(domain => `
                <div class="blocklist-item" data-domain="${escapeHtml(domain)}">
                    <span class="blocklist-domain">${escapeHtml(domain)}</span>
                    <button class="blocklist-unblock" title="Unblock this site">&times;</button>
                </div>
            `).join('');

            content.querySelectorAll('.blocklist-unblock').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const domain = btn.closest('.blocklist-item').dataset.domain;
                    sendIpc('unblock_domain', { domain });
                    // Refresh the list
                    setTimeout(fetchBlocklist, 100);
                });
            });
        }

        function toggleBlocklistDropdown() {
            const dropdown = document.getElementById('blocklistDropdown');
            if (!dropdown) return;

            blocklistDropdownOpen = !blocklistDropdownOpen;

            if (blocklistDropdownOpen) {
                dropdown.classList.remove('hidden');
                fetchBlocklist();
            } else {
                dropdown.classList.add('hidden');
            }
        }

        // Initialize sidebar actions
        function initSidebarActions() {
            const shieldStatus = document.getElementById('sidebarShieldStatus');
            const settingsBtn = document.getElementById('sidebarSettingsBtn');
            const newWorkspaceBtn = document.getElementById('newWorkspaceBtn');
            const blocklistBtn = document.getElementById('sidebarBlocklistBtn');

            if (shieldStatus) {
                shieldStatus.addEventListener('click', () => {
                    toggleShield();
                });
            }

            if (blocklistBtn) {
                blocklistBtn.addEventListener('click', (e) => {
                    // Don't toggle if clicking unblock button
                    if (e.target.classList.contains('blocklist-unblock')) return;
                    toggleBlocklistDropdown();
                });
            }

            // Close blocklist dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (blocklistDropdownOpen && !e.target.closest('#sidebarBlocklistBtn')) {
                    const dropdown = document.getElementById('blocklistDropdown');
                    if (dropdown) dropdown.classList.add('hidden');
                    blocklistDropdownOpen = false;
                }
            });

            const reportBtn = document.getElementById('sidebarReportBtn');
            if (reportBtn) {
                reportBtn.addEventListener('click', () => {
                    sendIpc('create_tab', { url: 'hiwave://report' });
                });
            }

            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => {
                    sendIpc('open_settings');
                });
            }

            // Focus mode test button
            const focusTestBtn = document.getElementById('focusTestBtn');
            if (focusTestBtn) {
                focusTestBtn.addEventListener('click', () => {
                    console.log('[Focus] Test button clicked - toggling focus mode');
                    sendIpc('toggle_focus_mode', {});
                });
            }

            if (newWorkspaceBtn) {
                const form = document.getElementById('newWorkspaceForm');
                const nameInput = document.getElementById('newWorkspaceName');
                const cancelBtn = document.getElementById('cancelNewWorkspace');
                const confirmBtn = document.getElementById('confirmNewWorkspace');

                newWorkspaceBtn.addEventListener('click', () => {
                    newWorkspaceBtn.classList.add('hidden');
                    form.classList.remove('hidden');
                    nameInput.value = '';
                    nameInput.focus();
                });

                cancelBtn.addEventListener('click', () => {
                    form.classList.add('hidden');
                    newWorkspaceBtn.classList.remove('hidden');
                });

                confirmBtn.addEventListener('click', () => {
                    const name = nameInput.value.trim();
                    if (name) {
                        sendIpc('create_workspace', { name });
                        form.classList.add('hidden');
                        newWorkspaceBtn.classList.remove('hidden');
                    }
                });

                nameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        confirmBtn.click();
                    } else if (e.key === 'Escape') {
                        cancelBtn.click();
                    }
                });
            }

            // Initial fetch of blocklist count
            fetchBlocklist();
        }

        // Event listeners for sidebar
        sidebarToggle.addEventListener('click', toggleSidebar);
        sidebarLogoToggle.addEventListener('click', toggleSidebar); // Logo toggle also opens sidebar

        // Initialize collapsible sections
        initCollapsibleSections();

        // Initialize sidebar resize
        initSidebarResize();

        // Load saved sidebar width - response handled via hiwaveChrome.setSidebarWidth
        sendIpc('get_sidebar_width', {});

        // Helper to extract hostname from URL
        function getDisplayName(tab) {
            if (tab.title && tab.title !== 'New Tab' && tab.title.trim() !== '') {
                return tab.title;
            }
            try {
                const url = new URL(tab.url);
                return url.hostname.replace(/^www\./, '');
            } catch {
                return tab.url || 'New Tab';
            }
        }

        // Chrome controller object exposed to Rust
        window.hiwaveChrome = {
            // Set sidebar width (called from backend on startup)
            setSidebarWidth: function(width) {
                const clampedWidth = Math.max(48, Math.min(400, width));
                sidebar.style.width = clampedWidth + 'px';
                updateSidebarMode(clampedWidth);
                console.log('[Sidebar] Width set from backend:', clampedWidth);
            },

            // Render tabs from backend state
            renderTabs: function(tabs) {
                currentTabs = tabs;
                const container = document.getElementById('tabs');
                container.innerHTML = '';

                tabs.forEach(tab => {
                    const tabEl = document.createElement('div');
                    let tabClass = 'tab';
                    if (tab.is_active) tabClass += ' active';
                    if (tab.locked) tabClass += ' locked';
                    tabEl.className = tabClass;
                    const tabId = String(tab.id);
                    tabEl.dataset.id = tabId;
                    tabEl.dataset.decay = String(tab.decay_level || 0);
                    tabEl.draggable = true;

                    if (tab.is_active) {
                        activeTabId = tabId;
                    }

                    const displayName = getDisplayName(tab);
                    const decayLevel = tab.decay_level || 0;
                    const isPlayingAudio = tab.is_playing_audio || false;
                    const isMuted = tab.is_muted || false;

                    // Audio icon: speaker when playing, muted speaker when muted, hidden otherwise
                    let audioIcon = '';
                    if (isPlayingAudio || isMuted) {
                        const iconClass = isMuted ? 'tab-audio muted' : 'tab-audio';
                        const icon = isMuted ? '&#128263;' : '&#128266;';  //  or 
                        const title = isMuted ? 'Unmute tab' : 'Mute tab';
                        audioIcon = `<span class="${iconClass}" title="${title}">${icon}</span>`;
                    }

                    tabEl.innerHTML = `
                        <span class="tab-decay-indicator"></span>
                        ${audioIcon}
                        <span class="tab-title">${escapeHtml(displayName)}</span>
                        <span class="tab-block" title="Block this domain and close tab">&#128737;</span>
                        <span class="tab-close" title="Close tab">&times;</span>
                    `;
                    tabEl.addEventListener('dragstart', (e) => {
                        draggingTabId = tabId;
                        if (e.dataTransfer) {
                            e.dataTransfer.setData('text/plain', tabId);
                            e.dataTransfer.effectAllowed = 'move';
                        }
                        tabEl.classList.add('dragging');
                    });

                    tabEl.addEventListener('dragend', () => {
                        if (draggingTabId === tabId) {
                            draggingTabId = null;
                        }
                        tabEl.classList.remove('dragging');
                    });
                    container.appendChild(tabEl);
                });

                const activeTab = tabs.find(t => t.is_active);
                if (activeTab) {
                    const displayName = getDisplayName(activeTab);
                    document.title = displayName !== 'New Tab' ? `${displayName} - HiWave` : 'HiWave';
                }

                // Update workspace tab count
                updateWorkspaceTabCount();

                // Scroll active tab into view (centered)
                this.scrollToActiveTab();

                console.log('Rendered', tabs.length, 'tabs');
            },

            // Scroll the active tab to the center of the tab bar
            scrollToActiveTab: function() {
                const container = document.getElementById('tabs');
                const activeTab = container.querySelector('.tab.active');
                if (!activeTab || !container) return;

                // Use requestAnimationFrame to ensure DOM is updated
                requestAnimationFrame(() => {
                    const containerRect = container.getBoundingClientRect();
                    const tabRect = activeTab.getBoundingClientRect();

                    // Calculate the scroll position to center the tab
                    const tabCenter = tabRect.left + tabRect.width / 2;
                    const containerCenter = containerRect.left + containerRect.width / 2;
                    const scrollOffset = tabCenter - containerCenter;

                    // Smooth scroll to center the tab
                    container.scrollBy({
                        left: scrollOffset,
                        behavior: 'smooth'
                    });
                });
            },

            // Render workspaces from backend state
            renderWorkspaces: function(workspaces) {
                currentWorkspaces = workspaces;

                // Update active workspace name in toggle button
                const activeWs = workspaces.find(ws => ws.is_active);
                if (activeWs) {
                    activeWorkspaceId = activeWs.id;
                    const workspaceLabel = workspaces.length > 1
                        ? `${activeWs.name} (${workspaces.length})`
                        : activeWs.name;
                    document.getElementById('workspaceName').textContent = workspaceLabel;
                }

                // Auto-expand active workspace only on first render, or if expanded workspace was deleted
                if (!workspacesInitialized) {
                    expandedWorkspaceId = activeWs ? activeWs.id : null;
                    workspacesInitialized = true;
                } else if (expandedWorkspaceId && !workspaces.some(ws => ws.id === expandedWorkspaceId)) {
                    // Expanded workspace was deleted, switch to active
                    expandedWorkspaceId = activeWs ? activeWs.id : null;
                }

                // Render workspaces in sidebar
                renderSidebarWorkspaces();
                updateWorkspaceBadge();
                updateShelfTitle();
                if (shelfScope === 'workspace') {
                    requestShelf();
                }

                console.log('Rendered', workspaces.length, 'workspaces');
            },

            renderShelf: function(payload) {
                if (!payload) return;
                shelfScope = payload.scope === 'all' ? 'all' : 'workspace';
                shelfItems = Array.isArray(payload.items) ? payload.items : [];
                globalShelfCount = Number(payload.global_count || 0);
                renderSidebarWorkspaces();
                renderShelf();
            },

            // Update URL in address bar
            updateUrl: function(url) {
                document.getElementById('urlInput').value = url;
            },

            // Update active tab title
            updateTitle: function(title) {
                const activeTab = document.querySelector('.tab.active .tab-title');
                if (activeTab) {
                    activeTab.textContent = title || 'New Tab';
                }
                document.title = title ? `${title} - HiWave` : 'HiWave';
            },

            // Update navigation button states
            updateNavState: function(canGoBack, canGoForward) {
                document.getElementById('backBtn').classList.toggle('disabled', !canGoBack);
                document.getElementById('forwardBtn').classList.toggle('disabled', !canGoForward);
                navState.canGoBack = canGoBack;
                navState.canGoForward = canGoForward;
            },

            // Set loading state
            setLoading: function(loading) {
                document.getElementById('loadingIndicator').classList.toggle('active', loading);
            },

            updateFindState: function(state) {
                if (!state) {
                    updateFindCountText(0, -1);
                    return;
                }
                const count = Number(state.count || 0);
                const index = Number(state.index || -1);
                updateFindCountText(count, index);
                if (findInput && typeof state.query === 'string') {
                    findInput.value = state.query;
                }
            },

            updateShieldStats: function(stats) {
                if (!stats) return;
                shieldEnabled = stats.enabled !== false;
                shieldStats = {
                    requests_blocked: Number(stats.requests_blocked || 0),
                    trackers_blocked: Number(stats.trackers_blocked || 0)
                };
                updateShieldDisplay();
            },

            // Update blocklist from backend
            updateBlocklist: function(domains) {
                renderBlocklist(domains);
            },

            updateDownloads: function(payload) {
                if (!payload) return;
                const downloads = Array.isArray(payload.downloads) ? payload.downloads : [];
                activeDownloadCount = Number(payload.active_count || 0);
                updateDownloadsBadge();
                renderDownloadsList(downloads);
            },

            updateHistory: function(entries) {
                currentHistory = Array.isArray(entries) ? entries : [];
                renderHistoryList();
            },

            // Get current active tab ID
            getActiveTabId: function() {
                return activeTabId;
            },

            // Focus mode config (populated on enter)
            _focusModeConfig: {
                show_progress_bar: true,
                hide_cursor: true,
                cursor_hide_delay_secs: 3
            },

            // Focus mode methods
            setFocusMode: function(active, config) {
                const body = document.body;
                const progressBar = document.getElementById('focusProgressBar');
                const hint = document.getElementById('focusHint');

                if (active) {
                    // Store config for later use
                    if (config) {
                        this._focusModeConfig = {
                            show_progress_bar: config.show_progress_bar !== false,
                            hide_cursor: config.hide_cursor !== false,
                            cursor_hide_delay_secs: config.cursor_hide_delay_secs || 3
                        };
                    }

                    // Close all open panels before entering focus mode
                    // Close left sidebar
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar && !sidebar.classList.contains('collapsed')) {
                        sidebar.classList.add('collapsed');
                        sidebarOpen = false;
                        sendIpc('set_sidebar_open', { open: false });
                    }
                    // Close right sidebar
                    const rightSidebar = document.getElementById('rightSidebar');
                    if (rightSidebar && !rightSidebar.classList.contains('collapsed')) {
                        rightSidebar.classList.add('collapsed');
                        rightSidebarOpen = false;
                    }
                    // Close find modal
                    const findModal = document.getElementById('findModal');
                    if (findModal && findModal.classList.contains('open')) {
                        findModal.classList.remove('open');
                        findModal.setAttribute('aria-hidden', 'true');
                        findModalOpen = false;
                    }
                    // Close tab actions panel if open
                    const tabActionsPanel = document.getElementById('tabActionsPanel');
                    if (tabActionsPanel) {
                        tabActionsPanel.style.display = 'none';
                    }
                    // Close shortcuts panel if visible
                    const shortcutsPanel = document.getElementById('shortcutsPanel');
                    if (shortcutsPanel && shortcutsPanel.style.display !== 'none') {
                        shortcutsPanel.style.display = 'none';
                    }

                    // Enter focus mode
                    body.classList.add('focus-mode');
                    body.classList.remove('peek-mode'); // Clear any peek state

                    // Only show progress bar if enabled
                    if (progressBar && this._focusModeConfig.show_progress_bar) {
                        progressBar.classList.add('visible');
                    }

                    // Show hint briefly
                    if (hint) {
                        hint.classList.add('visible');
                        setTimeout(() => {
                            hint.classList.remove('visible');
                        }, 3000);
                    }

                    // Start cursor hide timer only if enabled
                    if (this._focusModeConfig.hide_cursor) {
                        this.startCursorHideTimer();
                    }

                    console.log('[Focus] Entered focus mode with config:', this._focusModeConfig);
                } else {
                    // Exit focus mode
                    body.classList.remove('focus-mode');
                    body.classList.remove('peek-mode');
                    body.classList.remove('cursor-hidden');
                    if (progressBar) progressBar.classList.remove('visible');
                    if (hint) hint.classList.remove('visible');

                    // Clear inline styles set during focus mode entry
                    const tabActionsPanel = document.getElementById('tabActionsPanel');
                    if (tabActionsPanel) {
                        tabActionsPanel.style.display = '';
                    }
                    const shortcutsPanel = document.getElementById('shortcutsPanel');
                    if (shortcutsPanel) {
                        shortcutsPanel.style.display = '';
                    }

                    // Clear timers
                    this.clearPeekHideTimer();
                    this.clearCursorHideTimer();

                    console.log('[Focus] Exited focus mode');
                }
            },

            // Peek mode state
            _peekVisible: false,
            _peekHideTimer: null,
            _cursorHideTimer: null,

            showPeek: function() {
                if (!document.body.classList.contains('focus-mode')) return;
                if (this._peekVisible) return;

                this._peekVisible = true;
                document.body.classList.add('peek-mode');
                document.body.classList.remove('cursor-hidden');
                this.clearPeekHideTimer();
                sendIpc('show_focus_peek', {});
                console.log('[Focus] Showing peek UI');
            },

            hidePeek: function() {
                if (!this._peekVisible) return;

                // Delay hiding to allow user to move mouse into toolbar
                this._peekHideTimer = setTimeout(() => {
                    this._peekVisible = false;
                    document.body.classList.remove('peek-mode');
                    sendIpc('hide_focus_peek', {});
                    console.log('[Focus] Hiding peek UI');
                }, 500);
            },

            clearPeekHideTimer: function() {
                if (this._peekHideTimer) {
                    clearTimeout(this._peekHideTimer);
                    this._peekHideTimer = null;
                }
            },

            // Cursor hide functionality
            startCursorHideTimer: function() {
                if (!this._focusModeConfig.hide_cursor) return;
                this.clearCursorHideTimer();
                const delay = (this._focusModeConfig.cursor_hide_delay_secs || 3) * 1000;
                this._cursorHideTimer = setTimeout(() => {
                    if (document.body.classList.contains('focus-mode') &&
                        !document.body.classList.contains('peek-mode')) {
                        document.body.classList.add('cursor-hidden');
                    }
                }, delay);
            },

            clearCursorHideTimer: function() {
                if (this._cursorHideTimer) {
                    clearTimeout(this._cursorHideTimer);
                    this._cursorHideTimer = null;
                }
                document.body.classList.remove('cursor-hidden');
            },

            resetCursorHideTimer: function() {
                if (document.body.classList.contains('focus-mode') && this._focusModeConfig.hide_cursor) {
                    document.body.classList.remove('cursor-hidden');
                    this.startCursorHideTimer();
                }
            },

            updateFocusModeStatus: function(status) {
                const progressBar = document.getElementById('focusProgressBar');
                const progressFill = document.getElementById('focusProgressFill');

                if (!status) return;

                if (status.active && progressFill) {
                    // Update scroll progress
                    const progress = (status.scroll_progress || 0) * 100;
                    progressFill.style.width = progress + '%';
                }

                // Update peek visibility
                if (status.peek_visible !== this._peekVisible) {
                    if (status.peek_visible) {
                        document.body.classList.add('peek-mode');
                    } else {
                        document.body.classList.remove('peek-mode');
                    }
                    this._peekVisible = status.peek_visible;
                }

                // Update visibility
                if (progressBar) {
                    if (status.active) {
                        progressBar.classList.add('visible');
                    } else {
                        progressBar.classList.remove('visible');
                    }
                }
            },

            toggleFocusMode: function() {
                sendIpc('toggle_focus_mode', {});
            },

            exitFocusMode: function() {
                sendIpc('exit_focus_mode', {});
            },

            // UI shortcut handlers (called from content WebView via backend)
            closeActiveTab: function() {
                sendIpc('close_tab', { id: 'active' });
            },

            focusAddressBar: function() {
                const urlInput = document.getElementById('urlInput');
                if (urlInput) {
                    urlInput.focus();
                    urlInput.select();
                }
            },

            openFind: function() {
                // Open find modal
                const findModal = document.getElementById('findModal');
                if (findModal && !findModal.classList.contains('visible')) {
                    findModal.classList.add('visible');
                    const findInput = findModal.querySelector('.find-input');
                    if (findInput) {
                        findInput.focus();
                        findInput.select();
                    }
                }
            },

            toggleSidebar: function() {
                toggleSidebar();
            },

            openCommandPalette: function() {
                // Open command palette (same as Ctrl+K)
                const urlInput = document.getElementById('urlInput');
                if (urlInput) {
                    urlInput.focus();
                    urlInput.select();
                }
            },

            activateTabByIndex: function(index) {
                // Activate tab by 0-based index
                if (currentTabs && currentTabs[index]) {
                    const tabId = String(currentTabs[index].id);
                    sendIpc('activate_tab', { id: tabId });
                }
            }
        };

        // Helper to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Address bar navigation
        const urlInput = document.getElementById('urlInput');
        urlInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const url = urlInput.value.trim();
                if (url) {
                    sendIpc('navigate', { url });
                }
            }
        });

        // Track if the input was already focused to avoid select-all on every click
        let urlInputWasFocused = false;
        urlInput.addEventListener('focus', () => {
            // Only select all on initial focus (e.g., tabbing into the field)
            // Don't select all when clicking within an already-focused input
            if (!urlInputWasFocused) {
                urlInput.select();
            }
            urlInputWasFocused = true;
        });
        urlInput.addEventListener('blur', () => {
            urlInputWasFocused = false;
        });
        // Allow clicking to position cursor without selecting all
        urlInput.addEventListener('mousedown', () => {
            if (document.activeElement === urlInput) {
                // Input is already focused, don't select all
                urlInputWasFocused = true;
            }
        });

        // New tab button
        document.getElementById('newTabBtn').addEventListener('click', () => {
            sendIpc('create_tab');
        });

        // Command palette button (if it exists in the toolbar)
        const cmdPaletteBtn = document.getElementById('cmdPaletteBtn');
        if (cmdPaletteBtn) {
            cmdPaletteBtn.addEventListener('click', () => {
                openCommandPalette();
            });
        }

        // Navigation buttons
        document.getElementById('backBtn').addEventListener('click', () => {
            sendIpc('go_back');
        });

        document.getElementById('forwardBtn').addEventListener('click', () => {
            sendIpc('go_forward');
        });

        document.getElementById('refreshBtn').addEventListener('click', () => {
            sendIpc('reload');
        });

        // Shield button
        document.getElementById('shieldBtn').addEventListener('click', () => {
            toggleShield();
        });

        // Zoom indicator - click to reset zoom
        document.getElementById('zoomIndicator').addEventListener('click', () => {
            sendIpc('reset_zoom', {});
        });

        // Track focus mode state
        let focusModeActive = false;

        // Detect macOS for platform-specific shortcuts
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;

        // Update platform-specific UI hints
        if (isMac) {
            const focusHintKey = document.getElementById('focusHintKey');
            if (focusHintKey) {
                focusHintKey.textContent = 'F';
            }

            // Update shortcuts panel for macOS
            document.querySelectorAll('[data-key="mod"]').forEach(el => {
                el.textContent = '';
            });
            document.querySelectorAll('[data-key="alt"]').forEach(el => {
                el.textContent = '';
            });

            // Update Focus Mode shortcut for macOS
            const focusModeShortcut = document.getElementById('focusModeShortcut');
            if (focusModeShortcut) {
                // Replace all kbd elements with single macOS shortcut
                const span = focusModeShortcut.querySelector('span');
                focusModeShortcut.innerHTML = '<kbd>F</kbd>' + span.outerHTML;
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            const isCtrl = e.ctrlKey || e.metaKey;
            const isAlt = e.altKey;
            const isShift = e.shiftKey;

            // Ctrl+Shift+F (or Cmd+Shift+F on Mac) - Toggle focus mode
            // Also F11 on Windows/Linux
            if (isCtrl && isShift && (e.key === 'f' || e.key === 'F')) {
                console.log('[Focus] Triggering focus mode toggle via Ctrl+Shift+F');
                e.preventDefault();
                sendIpc('toggle_focus_mode', {});
                return;
            }
            if (e.key === 'F11') {
                console.log('[Focus] Triggering focus mode toggle via F11');
                e.preventDefault();
                sendIpc('toggle_focus_mode', {});
                return;
            }

            // Escape closes find bar, sidebars, or exits focus mode
            if (e.key === 'Escape') {
                console.log('[Key] Escape pressed, focus-mode:', document.body.classList.contains('focus-mode'));
                // Exit focus mode first if active
                if (document.body.classList.contains('focus-mode')) {
                    console.log('[Key] Exiting focus mode via Escape');
                    e.preventDefault();
                    e.stopPropagation();
                    sendIpc('exit_focus_mode', {});
                    // Also call setFocusMode directly as backup
                    if (window.hiwaveChrome) {
                        window.hiwaveChrome.setFocusMode(false);
                    }
                    return;
                }
                if (findModalOpen) {
                    e.preventDefault();
                    closeFindModal(true);
                    performFind('reset');
                    return;
                }
                if (sidebarOpen) {
                    toggleSidebar();
                    return;
                }
                sendIpc('stop');
                urlInput.blur();
            }

            // Ctrl+Shift+L - Trigger autofill
            if (isCtrl && isShift && (e.key === 'l' || e.key === 'L')) {
                e.preventDefault();
                // Request autofill trigger on the content page
                sendIpc('trigger_autofill', {});
                return;
            }

            // Ctrl+L - Focus address bar
            if (isCtrl && !isShift && (e.key === 'l' || e.key === 'L')) {
                e.preventDefault();
                urlInput.focus();
                urlInput.select();
                return;
            }

            // Ctrl+K - Command palette
            if (isCtrl && (e.key === 'k' || e.key === 'K')) {
                e.preventDefault();
                openCommandPalette();
            }

            // Ctrl+F - Find in page
            if (isCtrl && !isShift && (e.key === 'f' || e.key === 'F')) {
                e.preventDefault();
                openFindModal();
                performFind('reset');
                return;
            }

            // Ctrl+H - History
            if (isCtrl && (e.key === 'h' || e.key === 'H')) {
                e.preventDefault();
                toggleHistoryPanel();
            }

            // Ctrl+P - Print page
            if (isCtrl && (e.key === 'p' || e.key === 'P')) {
                e.preventDefault();
                sendIpc('print_page', {});
            }

            // Ctrl+T - New tab
            if (isCtrl && (e.key === 't' || e.key === 'T')) {
                e.preventDefault();
                sendIpc('create_tab');
            }

            // Ctrl+Shift+S - Shelve active tab
            if (isCtrl && isShift && (e.key === 's' || e.key === 'S')) {
                e.preventDefault();
                shelveActiveTab();
                return;
            }

            // Ctrl+W - Close tab
            if (isCtrl && (e.key === 'w' || e.key === 'W')) {
                e.preventDefault();
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    sendIpc('close_tab', { id: activeTab.dataset.id });
                }
            }

            // Ctrl+R or F5 - Reload
            if ((isCtrl && (e.key === 'r' || e.key === 'R')) || e.key === 'F5') {
                e.preventDefault();
                sendIpc('reload');
            }

            // Ctrl++ or Ctrl+= - Zoom in
            if (isCtrl && (e.key === '+' || e.key === '=')) {
                e.preventDefault();
                sendIpc('zoom_in', {});
            }

            // Ctrl+- - Zoom out
            if (isCtrl && e.key === '-') {
                e.preventDefault();
                sendIpc('zoom_out', {});
            }

            // Ctrl+0 - Reset zoom
            if (isCtrl && e.key === '0') {
                e.preventDefault();
                sendIpc('reset_zoom', {});
            }

            // Alt+Left - Back
            if (isAlt && e.key === 'ArrowLeft') {
                e.preventDefault();
                sendIpc('go_back');
            }

            // Alt+Right - Forward
            if (isAlt && e.key === 'ArrowRight') {
                e.preventDefault();
                sendIpc('go_forward');
            }

            // Alt+Home - Home
            if (isAlt && e.key === 'Home') {
                e.preventDefault();
                sendIpc('navigate', { url: 'https://start.duckduckgo.com' });
            }

            // F3 / Shift+F3 - Find navigation
            if (e.key === 'F3') {
                e.preventDefault();
                if (!findModalOpen) {
                    openFindModal();
                }
                performFind(e.shiftKey ? 'prev' : 'next');
            }

            // Ctrl+1-9 - Switch tabs
            if (isCtrl && e.key >= '1' && e.key <= '9') {
                e.preventDefault();
                const tabIndex = parseInt(e.key) - 1;
                if (currentTabs[tabIndex]) {
                    sendIpc('activate_tab', { id: String(currentTabs[tabIndex].id) });
                }
            }

            // Ctrl+B - Toggle sidebar
            if (isCtrl && (e.key === 'b' || e.key === 'B')) {
                e.preventDefault();
                toggleSidebar();
            }
        });

        // Tab management
        const tabsContainer = document.getElementById('tabs');

        tabsContainer.addEventListener('click', (e) => {
            const tab = e.target.closest('.tab');
            if (!tab) return;

            // Block button clicked - block domain and close tab
            if (e.target.classList.contains('tab-block')) {
                const tabId = tab.dataset.id;
                sendIpc('block_and_close', { id: tabId });
                return;
            }

            // Close button clicked
            if (e.target.classList.contains('tab-close')) {
                sendIpc('close_tab', { id: tab.dataset.id });
                return;
            }

            // Audio icon clicked - toggle mute
            if (e.target.classList.contains('tab-audio')) {
                sendIpc('toggle_tab_mute', { id: tab.dataset.id });
                return;
            }

            // Activate tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            sendIpc('activate_tab', { id: tab.dataset.id });

            // Scroll the activated tab to center
            if (window.hiwaveChrome && window.hiwaveChrome.scrollToActiveTab) {
                window.hiwaveChrome.scrollToActiveTab();
            }
        });

        // Request initial workspace state
        setTimeout(() => {
            sendIpc('get_workspaces');
            requestShelf();
        }, 600);

        // Initialize sidebar
        initModeSelector();
        initShelfDragDrop();
        initSidebarActions();
        updateShieldDisplay();
        syncSidebarLayout();

        if (toolbarDownloadsBtn) {
            toolbarDownloadsBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleDownloadsPanel();
                hideToolbarActionPanel();
            });
        }

        if (clearDownloadsBtn) {
            clearDownloadsBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                sendIpc('clear_downloads');
            });
        }

        if (toolbarHistoryBtn) {
            toolbarHistoryBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleHistoryPanel();
                hideToolbarActionPanel();
            });
        }

        if (clearHistoryBtn) {
            clearHistoryBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                sendIpc('clear_visit_history');
            });
        }

        if (toolbarMenuBtn) {
            toolbarMenuBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleRightSidebar();
            });
        }

        // Window control buttons (for frameless window on Windows)
        const windowMinimizeBtn = document.getElementById('windowMinimizeBtn');
        const windowMaximizeBtn = document.getElementById('windowMaximizeBtn');
        const windowCloseBtn = document.getElementById('windowCloseBtn');

        if (windowMinimizeBtn) {
            windowMinimizeBtn.addEventListener('click', () => {
                sendIpc('window_minimize');
            });
        }

        // Track window maximized state
        let isWindowMaximized = false;

        function updateMaximizeButton() {
            if (windowMaximizeBtn) {
                if (isWindowMaximized) {
                    // Show restore icon (two overlapping squares)
                    windowMaximizeBtn.innerHTML = '&#10697;';
                    windowMaximizeBtn.title = 'Restore Down';
                } else {
                    // Show maximize icon (single square)
                    windowMaximizeBtn.innerHTML = '&#9633;';
                    windowMaximizeBtn.title = 'Maximize';
                }
            }
        }

        if (windowMaximizeBtn) {
            windowMaximizeBtn.addEventListener('click', () => {
                sendIpc('window_toggle_maximize');
                isWindowMaximized = !isWindowMaximized;
                updateMaximizeButton();
            });
        }

        // Check initial window state
        isWindowMaximized = window.outerWidth >= screen.availWidth && window.outerHeight >= screen.availHeight;
        updateMaximizeButton();

        // Listen for window resize to detect maximize/restore from native controls
        window.addEventListener('resize', () => {
            // Check if window fills the screen (approximately maximized)
            const isNowMaximized = window.outerWidth >= screen.availWidth && window.outerHeight >= screen.availHeight;
            if (isNowMaximized !== isWindowMaximized) {
                isWindowMaximized = isNowMaximized;
                updateMaximizeButton();
            }
        });

        if (windowCloseBtn) {
            windowCloseBtn.addEventListener('click', () => {
                sendIpc('window_close');
            });
        }

        if (helpMenuBtn) {
            helpMenuBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleHelpPanel();
            });
        }

        // Right sidebar event listeners
        if (rightSidebarClose) {
            rightSidebarClose.addEventListener('click', () => {
                toggleRightSidebar();
            });
        }

        // Right sidebar tab switching
        const rightDownloadsPanel = document.getElementById('rightDownloadsPanel');
        const rightHistoryPanel = document.getElementById('rightHistoryPanel');
        const rightShortcutsPanel = document.getElementById('rightShortcutsPanel');
        const rightDownloadsList = document.getElementById('rightDownloadsList');
        const rightHistoryList = document.getElementById('rightHistoryList');
        const rightHistorySearch = document.getElementById('rightHistorySearch');
        const rightClearDownloadsBtn = document.getElementById('rightClearDownloadsBtn');
        const rightClearHistoryBtn = document.getElementById('rightClearHistoryBtn');

        function switchRightSidebarTab(panel) {
            // Update tab active states
            document.querySelectorAll('.right-sidebar-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.panel === panel);
            });
            // Update panel visibility
            if (rightDownloadsPanel) {
                rightDownloadsPanel.classList.toggle('active', panel === 'downloads');
            }
            if (rightHistoryPanel) {
                rightHistoryPanel.classList.toggle('active', panel === 'history');
            }
            if (rightShortcutsPanel) {
                rightShortcutsPanel.classList.toggle('active', panel === 'shortcuts');
            }
        }

        function renderRightDownloadsList() {
            if (!rightDownloadsList) return;
            if (currentDownloads.length === 0) {
                rightDownloadsList.innerHTML = '<div class="right-panel-empty">No downloads yet</div>';
                return;
            }
            rightDownloadsList.innerHTML = currentDownloads.slice(0, 10).map(dl => {
                const fileName = dl.file_name || dl.filename || 'Download';
                const statusText = dl.status === 'completed' ? 'Complete' : (dl.status || 'Pending');
                return `
                    <div class="right-panel-item" title="${escapeAttr(dl.path || dl.url || '')}">
                        <div class="right-panel-item-title">${escapeHtml(fileName)}</div>
                        <div class="right-panel-item-meta">${escapeHtml(statusText)}</div>
                    </div>
                `;
            }).join('');
        }

        function renderRightHistoryList() {
            if (!rightHistoryList) return;
            const searchTerm = rightHistorySearch ? rightHistorySearch.value.toLowerCase() : '';
            const filtered = currentHistory.filter(h =>
                !searchTerm ||
                (h.title && h.title.toLowerCase().includes(searchTerm)) ||
                (h.url && h.url.toLowerCase().includes(searchTerm))
            ).slice(0, 15);

            if (filtered.length === 0) {
                rightHistoryList.innerHTML = '<div class="right-panel-empty">No history yet</div>';
                return;
            }
            rightHistoryList.innerHTML = filtered.map(h => {
                const safeUrl = escapeAttr(h.url || '');
                return `
                    <div class="right-panel-item" data-url="${safeUrl}" onclick="sendIpc('navigate', {url:'${safeUrl}'})">
                        <div class="right-panel-item-title">${escapeHtml(h.title || 'Untitled')}</div>
                        <div class="right-panel-item-url">${escapeHtml(h.url || '')}</div>
                    </div>
                `;
            }).join('');
        }

        if (rightSidebarDownloadsBtn) {
            rightSidebarDownloadsBtn.addEventListener('click', () => {
                switchRightSidebarTab('downloads');
                renderRightDownloadsList();
            });
        }

        if (rightSidebarHistoryBtn) {
            rightSidebarHistoryBtn.addEventListener('click', () => {
                switchRightSidebarTab('history');
                renderRightHistoryList();
            });
        }

        if (rightSidebarHelpBtn) {
            rightSidebarHelpBtn.addEventListener('click', () => {
                switchRightSidebarTab('shortcuts');
            });
        }

        if (rightHistorySearch) {
            rightHistorySearch.addEventListener('input', () => {
                renderRightHistoryList();
            });
        }

        if (rightClearDownloadsBtn) {
            rightClearDownloadsBtn.addEventListener('click', () => {
                sendIpc('clear_downloads');
            });
        }

        if (rightClearHistoryBtn) {
            rightClearHistoryBtn.addEventListener('click', () => {
                sendIpc('clear_visit_history');
            });
        }

        // Right sidebar search button
        const rightSidebarSearchBtn = document.getElementById('rightSidebarSearch');
        if (rightSidebarSearchBtn) {
            rightSidebarSearchBtn.addEventListener('click', () => {
                toggleRightSidebar(); // Close the sidebar
                openCommandPalette();
            });
        }

        // Tab Actions Panel event listeners
        if (tabActionsPanelClose) {
            tabActionsPanelClose.addEventListener('click', () => {
                hideTabActionsPanel();
            });
        }

        if (tabActionLock) {
            tabActionLock.addEventListener('click', () => {
                if (tabActionsPanelTabId) {
                    const tab = currentTabs.find(t => String(t.id) === String(tabActionsPanelTabId));
                    if (tab) {
                        if (tab.locked) {
                            sendIpc('unlock_page', { tab_id: String(tabActionsPanelTabId) });
                        } else {
                            sendIpc('lock_page', { tab_id: String(tabActionsPanelTabId) });
                        }
                    }
                    hideTabActionsPanel();
                }
            });
        }

        if (tabActionShelve) {
            tabActionShelve.addEventListener('click', () => {
                if (tabActionsPanelTabId) {
                    sendIpc('add_to_shelf', { tab_id: String(tabActionsPanelTabId) });
                    hideTabActionsPanel();
                }
            });
        }

        if (tabActionMove) {
            tabActionMove.addEventListener('click', (event) => {
                if (tabActionsPanelTabId) {
                    // Show workspace picker submenu
                    const workspaceItems = currentWorkspaces
                        .filter(w => !w.is_active)
                        .map(w => ({
                            label: w.name,
                            icon: '',
                            action: 'move_to_workspace',
                            tabId: tabActionsPanelTabId,
                            workspaceId: w.id
                        }));

                    if (workspaceItems.length > 0) {
                        hideTabActionsPanel();
                        renderContextMenu(workspaceItems, event.clientX, event.clientY);
                    }
                }
            });
        }

        if (tabActionDuplicate) {
            tabActionDuplicate.addEventListener('click', () => {
                if (tabActionsPanelTabId) {
                    const tab = currentTabs.find(t => String(t.id) === String(tabActionsPanelTabId));
                    if (tab && tab.url) {
                        sendIpc('create_tab', { url: tab.url });
                    }
                    hideTabActionsPanel();
                }
            });
        }

        if (tabActionCopyUrl) {
            tabActionCopyUrl.addEventListener('click', async () => {
                if (tabActionsPanelTabId) {
                    const tab = currentTabs.find(t => String(t.id) === String(tabActionsPanelTabId));
                    if (tab && tab.url) {
                        const success = await copyToClipboard(tab.url);
                        if (!success) {
                            console.error('Failed to copy URL:', tab.url);
                        }
                    }
                    hideTabActionsPanel();
                }
            });
        }

        if (tabActionCloseOthers) {
            tabActionCloseOthers.addEventListener('click', () => {
                if (tabActionsPanelTabId) {
                    currentTabs.forEach(t => {
                        if (String(t.id) !== String(tabActionsPanelTabId) && !t.locked) {
                            sendIpc('close_tab', { id: String(t.id) });
                        }
                    });
                    hideTabActionsPanel();
                }
            });
        }

        if (tabActionClose) {
            tabActionClose.addEventListener('click', () => {
                if (tabActionsPanelTabId) {
                    sendIpc('close_tab', { id: String(tabActionsPanelTabId) });
                    hideTabActionsPanel();
                }
            });
        }

        if (historySearch) {
            historySearch.addEventListener('input', () => {
                renderHistoryList();
            });
        }

        document.addEventListener('click', (event) => {
            if (
                downloadsPanelOpen &&
                !event.target.closest('#downloadsPanel')
            ) {
                hideDownloadsPanel();
            }
            if (
                historyPanelOpen &&
                !event.target.closest('#historyPanel')
            ) {
                hideHistoryPanel();
            }
            if (
                toolbarActionOpen &&
                !event.target.closest('.toolbar-action-menu')
            ) {
                hideToolbarActionPanel();
            }
            if (
                helpPanelOpen &&
                !event.target.closest('#helpMenu')
            ) {
                hideHelpPanel();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                // Focus mode exit takes priority over panel closing
                if (document.body.classList.contains('focus-mode')) {
                    // Let the main keydown handler deal with it
                    return;
                }
                if (tabActionsPanelOpen) {
                    hideTabActionsPanel();
                    return;
                }
                if (downloadsPanelOpen) {
                    hideDownloadsPanel();
                    return;
                }
                if (historyPanelOpen) {
                    hideHistoryPanel();
                    return;
                }
                if (toolbarActionOpen) {
                    hideToolbarActionPanel();
                    return;
                }
                if (helpPanelOpen) {
                    hideHelpPanel();
                    return;
                }
            }
        });
        updateWorkspaceBadge();

        // ========================================
        // PEEK MODE EVENT LISTENERS
        // ========================================

        // Reveal zone hover detection
        const revealZone = document.getElementById('focusRevealZone');
        if (revealZone) {
            revealZone.addEventListener('mouseenter', () => {
                if (document.body.classList.contains('focus-mode')) {
                    window.hiwaveChrome.showPeek();
                }
            });

            revealZone.addEventListener('mouseleave', () => {
                // Don't hide immediately - user might be moving to toolbar
                // The toolbar hover handlers will cancel the hide if needed
            });
        }

        // Toolbar hover to cancel peek hide timer
        const toolbar = document.querySelector('.toolbar');
        if (toolbar) {
            toolbar.addEventListener('mouseenter', () => {
                if (document.body.classList.contains('peek-mode')) {
                    window.hiwaveChrome.clearPeekHideTimer();
                }
            });

            toolbar.addEventListener('mouseleave', () => {
                if (document.body.classList.contains('peek-mode')) {
                    window.hiwaveChrome.hidePeek();
                }
            });
        }

        // Peek exit button click
        const peekExitBtn = document.getElementById('peekExitBtn');
        if (peekExitBtn) {
            peekExitBtn.addEventListener('click', () => {
                window.hiwaveChrome.exitFocusMode();
            });
        }

        // Mouse movement to reset cursor hide timer
        document.addEventListener('mousemove', () => {
            if (document.body.classList.contains('focus-mode')) {
                window.hiwaveChrome.resetCursorHideTimer();
            }
        });

        // Also detect mouse at very top of screen (fallback for when reveal zone isn't hit)
        document.addEventListener('mousemove', (e) => {
            if (!document.body.classList.contains('focus-mode')) return;

            // If mouse is in top 25px and center 60%
            const windowWidth = window.innerWidth;
            const leftBound = windowWidth * 0.2;
            const rightBound = windowWidth * 0.8;

            if (e.clientY <= 25 && e.clientX >= leftBound && e.clientX <= rightBound) {
                window.hiwaveChrome.showPeek();
            }
        });

        console.log('HiWave Chrome initialized (sidebar UI)');
        if (window.ipc && window.ipc.postMessage) {
            sendIpc('chrome_ready');
        }
    </script>
</body>
</html>
